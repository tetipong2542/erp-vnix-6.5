{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
  <div>
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">üè∑Ô∏è</div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ (Internal)</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          SKU Pricing
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('download_price_internal_template') }}">
      <i class="bi bi-download me-1"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template
    </a>
    <a class="btn btn-light border" href="{{ url_for('price_dashboard') }}">
      <i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö Dashboard
    </a>
  </div>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body bg-light">

    <ul class="nav nav-pills mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-file" type="button" role="tab">
          <i class="bi bi-file-earmark-arrow-up me-1"></i>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-gsheet" type="button" role="tab">
          <i class="bi bi-google me-1"></i>Google Sheet
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- ================== FILE ================== -->
      <div class="tab-pane fade show active" id="tab-file" role="tabpanel">
        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="mode" value="file">

          <div class="row align-items-end g-2">
            <div class="col-md-9">
              <label class="form-label small text-muted mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel/CSV</label>
              <input class="form-control" type="file" name="file" accept=".xlsx,.xls,.csv" required>
            </div>

            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-cloud-upload me-1"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå
              </button>
            </div>

            <div class="col-12">
              <div class="form-text mt-1 text-muted" style="font-size: 0.85rem;">
                <i class="bi bi-info-circle me-1"></i>
                ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: <strong>SKU, Cost, Our Price</strong> (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° <strong>sku, cost, our_price</strong>)
                (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏° Brand/Name/Spec/Floor Price/Min Margin %/Pack Cost/Ship Subsidy)
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- ================== GSHEET ================== -->
      <div class="tab-pane fade" id="tab-gsheet" role="tabpanel">
        <form method="post">
          <input type="hidden" name="mode" value="gsheet">

          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-8">
              <label class="form-label">Google Sheet URL</label>
              <div class="d-flex gap-2">
                <input class="form-control"
                       id="sheet_url_internal"
                       name="sheet_url"
                       value="{{ saved_url or '' }}"
                       placeholder="https://docs.google.com/spreadsheets/d/..."
                       required>

                <button type="button" class="btn btn-outline-success"
                        onclick="saveGsheetUrlInternal()">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>

                <button type="button" class="btn btn-outline-danger"
                        onclick="deleteGsheetUrlInternal()">
                  ‡∏•‡∏ö
                </button>
              </div>
              <div class="form-text" style="min-height:20px;">
                ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô header: <b>sku, cost, our_price</b> (‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÑ‡∏î‡πâ)
              </div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Worksheet (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å)</label>
              <input class="form-control" id="worksheet_internal" name="worksheet" value="{{ saved_worksheet or '' }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô Internal">
              <div class="form-text" style="min-height:20px;">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏ô Google Sheet</div>
            </div>

            <div class="col-12 col-md-3 d-grid">
              <label class="form-label invisible">Submit</label>
              <button class="btn btn-primary">
                <i class="bi bi-cloud-download me-1"></i>‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheet
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<div class="card border-danger mt-3">
  <div class="card-header bg-danger text-white">Danger Zone</div>
  <div class="card-body">

    <h6 class="mb-2">1) Undo Import ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
    <div class="small text-secondary mb-2">
      ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏£‡∏≠‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Äù ‡∏Ç‡∏≠‡∏á Internal (SKU ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö)
      <br>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á Import ‡∏£‡∏≠‡∏ö‡∏ô‡∏±‡πâ‡∏ô ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢
      {% if last_batch %}
        <hr class="my-2">
        <div>‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: #{{ last_batch.id }} | ok {{ last_batch.ok_rows }} / skip {{ last_batch.skip_rows }}</div>
        <div>‡πÄ‡∏ß‡∏•‡∏≤: {{ last_batch.created_at }} | ‡πÇ‡∏î‡∏¢: {{ last_batch.created_by }}</div>
        {% if last_batch.source_name %}<div>‡πÅ‡∏´‡∏•‡πà‡∏á: {{ last_batch.source }} ‚Äî {{ last_batch.source_name }}</div>{% endif %}
      {% endif %}
    </div>

    <form method="POST" action="{{ url_for('undo_price_internal_last') }}"
          onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Undo ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î?\n‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏Å‡πâ/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö');">
      {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <button class="btn btn-outline-danger">Undo ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
    </form>

    <hr class="my-3">

    <h6 class="mb-2">2) ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Internal ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢)</h6>
    <div class="small text-danger mb-2">
      ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: Dashboard Price Marketing ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô Our Price/Cost ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Internal)
      <br>‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‚Äú‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á‚Äù (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏£‡∏≠‡∏á price.db ‡∏Å‡πà‡∏≠‡∏ô)
    </div>

    <form method="POST" action="{{ url_for('clear_price_internal_all') }}"
          onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á Internal ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: Dashboard ‡∏ù‡∏±‡πà‡∏á Internal ‡∏à‡∏∞‡∏ß‡πà‡∏≤‡∏á');">
      {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <label class="form-label">‡∏û‡∏¥‡∏°‡∏û‡πå <b>CLEAR INTERNAL</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
      <input class="form-control" name="confirm_text" placeholder="CLEAR INTERNAL" required>
      <button class="btn btn-danger mt-2">‡∏•‡πâ‡∏≤‡∏á Internal ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </form>

  </div>
</div>

<script>
async function saveGsheetUrlInternal(){
  const url = (document.getElementById('sheet_url_internal').value || '').trim();
  const worksheet = (document.getElementById('worksheet_internal')?.value || '').trim();
  const res = await fetch('/api/price/config/gsheet_url', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action:'save', platform:'PRICE_INTERNAL_SYSTEM', name:'GoogleSheet_Price_Internal', url, worksheet})
  });
  const data = await res.json();
  alert(data.msg || (data.success ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
}

async function deleteGsheetUrlInternal(){
  const res = await fetch('/api/price/config/gsheet_url', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action:'delete', platform:'PRICE_INTERNAL_SYSTEM', name:'GoogleSheet_Price_Internal'})
  });
  const data = await res.json();
  if (data.success) {
    document.getElementById('sheet_url_internal').value = '';
    const wsEl = document.getElementById('worksheet_internal');
    if (wsEl) wsEl.value = '';
  }
  alert(data.msg || (data.success ? '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
}
</script>
{% endblock %}
