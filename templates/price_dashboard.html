{% extends "base.html" %}

{% block content %}

<style>
	/* --- Top header --- */
	.pm-title-icon {
		width: 42px;
		height: 42px;
		border-radius: 14px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(var(--bs-primary-rgb), .08);
		font-size: 22px;
	}

	.pm-subtitle {
		border-left: 2px solid rgba(var(--bs-body-color-rgb), .12);
		padding-left: 12px;
	}

	/* --- Control Bar (Platform + Search) --- */
	.pm-control-card {
		border: 1px solid rgba(var(--bs-body-color-rgb), .06);
		border-radius: 16px;
		box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, .06);
	}

	.pm-control-card .card-body {
		padding: 16px;
	}

	/* --- Fix: Filter (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• / ‡πÅ‡∏™‡∏î‡∏á / ‡∏õ‡∏∏‡πà‡∏°) ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô --- */
	.pm-filter-form {
		width: 100%;
		max-width: 760px;
		/* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö ‡πÄ‡∏ä‡πà‡∏ô 680-820 */
		margin-left: auto;
		/* ‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏¢‡∏∏‡∏ö */
	}

	#limitSelect {
		min-width: 140px;
		/* ‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏Ç 200/300/1000/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î */
		padding-right: 2.8rem;
		/* ‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£ select ‡∏ö‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
	}

	.pm-filter-actions {
		display: flex;
		gap: 8px;
		justify-content: flex-end;
		flex-wrap: wrap;
		/* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ö select */
	}

	.pm-filter-actions .btn {
		white-space: nowrap;
	}

	.pm-platform-row {
		display: flex;
		align-items: center;
		gap: 10px;
		flex-wrap: nowrap;
	}

	.pm-platform-left {
		display: flex;
		gap: 8px;
		min-width: 320px;
		flex: 0 0 auto;
	}

	.pm-platform-pills {
		display: flex;
		gap: 8px;
		margin-left: auto;
		justify-content: flex-end;
		white-space: nowrap;
		overflow: hidden;
		min-width: 0;
	}

	.pm-platform-pills .pm-lock-pill,
	.pm-platform-pills .pm-fee-pill {
		flex: 0 0 auto;
	}

	@media (max-width: 992px) {
		.pm-platform-row {
			flex-wrap: wrap;
		}

		.pm-platform-pills {
			white-space: normal;
			overflow: visible;
		}
	}

	.pm-lock-pill {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 4px 10px;
		border-radius: 999px;
		background: rgba(var(--bs-success-rgb), .10);
		color: rgba(var(--bs-success-rgb), 1);
		font-size: 12px;
		font-weight: 600;
	}

	.pm-edit-pill {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 4px 10px;
		border-radius: 999px;
		background: rgba(var(--bs-warning-rgb), .12);
		color: rgba(var(--bs-warning-rgb), 1);
		font-size: 12px;
		font-weight: 700;
	}

	.pm-fee-pill {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 4px 10px;
		border-radius: 999px;
		background: rgba(var(--bs-dark-rgb), .05);
		font-size: 12px;
	}

	/* Import Platform modal - modern */
	#importPlatformModal .modal-content {
		border-radius: 16px;
	}

	#importPlatformModal .modal-header {
		border-bottom: 0;
		padding-bottom: 0;
	}

	#importPlatformModal .modal-title {
		font-weight: 800;
	}

	#importPlatformModal .imp-card {
		border: 1px solid rgba(var(--bs-body-color-rgb), .08);
		border-radius: 14px;
		background: var(--bs-body-bg);
		padding: 14px;
	}

	#importPlatformModal .imp-step {
		font-size: 12px;
		font-weight: 800;
		color: var(--bs-secondary-color);
		text-transform: uppercase;
		letter-spacing: .4px;
		margin-bottom: 8px;
		display: flex;
		align-items: center;
		gap: 8px;
	}

	#importPlatformModal .imp-step .dot {
		width: 22px;
		height: 22px;
		border-radius: 999px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(var(--bs-primary-rgb), .10);
		color: rgba(var(--bs-primary-rgb), 1);
	}

	/* --- KPI --- */
	.pm-kpi {
		border-radius: 16px;
		border: 1px solid rgba(var(--bs-body-color-rgb), .06);
		transition: transform .12s ease, box-shadow .12s ease;
		cursor: pointer;
		position: relative;
		overflow: hidden;
	}

	.pm-kpi-check {
		position: absolute;
		top: 10px;
		left: 10px;
		z-index: 10;
		display: flex;
		align-items: center;
		gap: 6px;
	}

	.pm-kpi-check input {
		width: 18px;
		height: 18px;
	}

	.pm-kpi-check .small {
		font-size: 12px;
		color: var(--bs-secondary-color);
	}

	/* ‡∏Å‡∏±‡∏ô checkbox ‡∏ó‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
	.pm-kpi-hascheck .card-body {
		padding-top: 22px;
		padding-left: 34px;
	}

	.pm-kpi::before {
		content: "";
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 4px;
		background: rgba(var(--bs-primary-rgb), .35);
	}

	.pm-kpi:hover {
		transform: translateY(-1px);
		box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .06);
	}

	.pm-kpi .pm-kpi-label {
		font-size: 12px;
		color: var(--bs-secondary-color);
		font-weight: 700;
		letter-spacing: .2px;
	}

	.pm-kpi .pm-kpi-value {
		font-size: 26px;
		font-weight: 800;
		line-height: 1;
	}

	.pm-kpi .pm-kpi-icon {
		width: 36px;
		height: 36px;
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(var(--bs-primary-rgb), .08);
	}

	/* --- Table --- */
	/* Freeze Header: ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Google Sheet) */
	.pm-table-wrap {
		border: 1px solid rgba(var(--bs-body-color-rgb), .06);
		border-radius: 16px;
		overflow: hidden;
		box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, .05);
	}

	.pm-table-scroll {
		max-height: calc(100vh - 100px);
		overflow: auto;
		overflow-x: auto;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		/* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏∑‡πà‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
		position: relative;
		border-radius: 16px;
	}

	/* ‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö‡∏à‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
	.pm-table {
		min-width: 1600px;
		/* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á */
	}

	.pm-table td,
	.pm-table th {
		white-space: nowrap;
	}

	.pm-table thead th {
		background: var(--bs-tertiary-bg);
		border-bottom: 1px solid rgba(var(--bs-body-color-rgb), .06);
		font-size: 12px;
		text-transform: none;
		letter-spacing: .2px;
		text-align: center !important;
		vertical-align: middle;
		white-space: nowrap;
	}

	.pm-table td,
	.pm-table th {
		padding: .60rem .65rem;
	}

	/* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á -> ‡∏ó‡∏≥‡πÇ‡∏´‡∏°‡∏î compact ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) */
	@media (max-width: 992px) {

		.pm-table th,
		.pm-table td {
			padding: .40rem .45rem;
		}

		.pm-table thead th {
			font-size: 11px;
		}

		.pm-table tbody td {
			font-size: 12px;
		}
	}

	@media (max-width: 768px) {

		.pm-table th,
		.pm-table td {
			padding: .32rem .40rem;
		}

		.pm-table thead th {
			font-size: 10.5px;
		}

		.pm-table tbody td {
			font-size: 11.5px;
		}
	}

	/* Zoom control (‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå; ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏≠‡∏á) */
	.pm-zoom-ctrl {
		position: fixed;
		right: 16px;
		bottom: 16px;
		z-index: 2000;
		display: flex;
		align-items: center;
		gap: 10px;
		padding: 10px 12px;
		border: 1px solid var(--bs-border-color);
		border-radius: 14px;
		background: rgba(var(--bs-body-bg-rgb), .95);
		box-shadow: var(--bs-box-shadow);
	}

	.pm-zoom-ctrl input[type="range"] {
		width: 140px;
	}

	/* === Zoom UI Toggle === */
	.pm-zoom-hidden {
		display: none !important;
	}

	.pm-zoom-fab {
		position: fixed;
		right: 16px;
		bottom: 16px;
		z-index: 2000;
		width: 44px;
		height: 44px;
		border-radius: 14px;
		border: 1px solid var(--bs-border-color);
		background: rgba(var(--bs-body-bg-rgb), .95);
		box-shadow: var(--bs-box-shadow);
		display: inline-flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
	}

	.pm-zoom-fab:hover {
		box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, .10);
	}

	/* fix sticky header background consistency (esp. last column) */
	.pm-table thead,
	.pm-table thead tr {
		background: var(--bs-tertiary-bg);
	}

	.pm-table thead {
		position: relative;
		z-index: 4;
	}

	.pm-table thead th {
		background: var(--bs-tertiary-bg) !important;
		background-clip: padding-box;
		z-index: 5;
	}

	/* Grouped header (2 rows) */
	.pm-group-row th {
		background: rgba(var(--bs-primary-rgb), .06) !important;
		border-bottom: 1px solid rgba(var(--bs-body-color-rgb), .08);
		font-weight: 800;
		font-size: 12px;
		position: sticky;
		top: 0;
		z-index: 30;
	}

	.pm-col-row th {
		position: sticky;
		top: var(--pm-group-h, 36px) !important;
		z-index: 29;
	}

	.pm-split-left {
		border-left: 2px solid rgba(var(--bs-body-color-rgb), .10) !important;
	}

	/* Subtle column tints for quick visual separation */
	.pm-col-cost {
		background: rgba(var(--bs-warning-rgb), .06);
	}

	.pm-col-our {
		background: rgba(var(--bs-primary-rgb), .04);
	}

	.pm-col-market {
		background: rgba(var(--bs-info-rgb), .05);
	}

	/* --- Improved Text Colors (High Contrast, theme-based) --- */
	/* --- Stock Internal: ‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô Pink (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Stock ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô) --- */
	.pm-table tbody td[data-col="stock_internal"] {
		color: var(--bs-pink);
		font-weight: 800;
	}

	.pm-table tbody td[data-col="stock"] {
		color: rgba(var(--bs-primary-rgb), 1);
		font-weight: 700;
	}

	.pm-table tbody td[data-col="cost"] {
		color: rgba(var(--bs-danger-rgb), 1);
		font-weight: 700;
	}

	.pm-table tbody td[data-col="our_price"] {
		color: rgba(var(--bs-success-rgb), 1);
		font-weight: 700;
	}

	.pm-table tbody td[data-col="market_best"] {
		color: rgba(var(--bs-secondary-rgb), 1);
		color: color-mix(in srgb, rgb(var(--bs-primary-rgb)) 55%, rgb(var(--bs-danger-rgb)) 45%);
		font-weight: 700;
	}

	.pm-table tbody td[data-col="voucher"] {
		/* ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô warning */
		color: color-mix(in srgb, rgb(var(--bs-warning-rgb)) 65%, rgb(var(--bs-dark-rgb)) 35%);
		font-weight: 700;
	}

	/* Monthly Sales: ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏Ñ‡∏£‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏° (‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á Performance/Turnover) */
	.pm-table tbody td[data-col="monthly_sales"] {
		color: #00838f;
		font-weight: 700;
	}

	.pm-table tbody td[data-col="brand_control"] {
		color: rgba(var(--bs-danger-rgb), 1);
		color: color-mix(in srgb, rgb(var(--bs-danger-rgb)) 70%, rgb(var(--bs-body-color-rgb)) 30%);
		font-weight: 700;
	}

	/* Profit: make the two columns clearly distinct */
	.pm-table tbody td[data-col="profit_our"] {
		color: #006064;
		font-weight: 700;
	}

	.pm-table tbody td[data-col="profit_match"] {
		color: #263238;
		font-weight: 700;
	}

	.pm-row-auto-selected {
		background: rgba(var(--bs-warning-rgb), .10) !important;
	}

	.pm-table tbody tr:hover {
		background: rgba(var(--bs-body-color-rgb), .02);
	}

	.pm-num {
		font-variant-numeric: tabular-nums;
	}

	/* ‚úÖ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ pm-num) ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
	.pm-table tbody td.pm-num {
		text-align: center !important;
	}

	.pm-muted {
		color: var(--bs-secondary-color);
		font-size: 12px;
	}

	/* --- Preset flash (Export Price & Stock Adj) --- */
	.preset-flash {
		animation: presetFlash .65s ease;
	}

	@keyframes presetFlash {
		0% {
			box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), .35);
		}

		100% {
			box-shadow: 0 0 0 .45rem rgba(var(--bs-primary-rgb), 0);
		}
	}

	/* optional: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
	.pm-col-sku {
		white-space: nowrap;
	}

	.pm-name {
		max-width: 260px;
	}

	/* --- Row status dot (‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πà‡∏≤ SKU) --- */
	.pm-row-dot {
		display: inline-block;
		width: 10px;
		height: 10px;
		border-radius: 999px;
		margin-right: 8px;
		vertical-align: middle;
		box-shadow: 0 0 0 3px rgba(var(--bs-body-bg-rgb), 1);
	}

	/* ===== Modern Stock Adj Modal ===== */
	.stock-adj-section-title {
		font-size: 0.85rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		color: var(--bs-secondary-color);
		margin-bottom: 10px;
		display: flex;
		align-items: center;
		gap: 6px;
	}

	/* Selectable Logic Card */
	.logic-card {
		border: 1px solid var(--bs-border-color);
		border-radius: 12px;
		padding: 14px;
		background: var(--bs-body-bg);
		transition: all 0.2s ease;
		cursor: pointer;
		position: relative;
		height: 100%;
	}

	.logic-card:hover {
		border-color: var(--bs-primary);
		background: var(--bs-tertiary-bg);
	}

	.logic-card.active {
		border-color: var(--bs-primary);
		background: rgba(var(--bs-primary-rgb), 0.04);
		box-shadow: 0 0 0 1px var(--bs-primary);
	}

	.logic-card .form-check-input {
		transform: scale(1.2);
		margin-top: 2px;
	}

	.logic-card-content {
		padding-left: 8px;
	}

	.logic-card-title {
		font-weight: 600;
		color: var(--bs-heading-color);
		font-size: 0.95rem;
		margin-bottom: 2px;
	}

	.logic-card-desc {
		font-size: 0.8rem;
		color: var(--bs-secondary-color);
		line-height: 1.3;
	}

	.logic-card-inputs {
		margin-top: 10px;
		padding-top: 10px;
		border-top: 1px dashed var(--bs-border-color);
		animation: fadeIn 0.2s ease-in-out;
	}

	/* Column Picker Grid */
	.col-picker-group {
		background: var(--bs-tertiary-bg);
		border-radius: 12px;
		padding: 12px;
		height: 100%;
	}

	.col-picker-title {
		font-weight: 700;
		font-size: 0.85rem;
		margin-bottom: 8px;
		color: var(--bs-heading-color);
	}

	.col-check-item {
		display: flex;
		align-items: center;
		gap: 8px;
		margin-bottom: 6px;
		font-size: 0.9rem;
		color: var(--bs-body-color);
		cursor: pointer;
	}

	.col-check-item:hover {
		color: var(--bs-primary);
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(-5px);
		}

		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* ===== Modern Stock Adj UI (Card-based Selection) ===== */
	.sa-section-title {
		font-size: 0.8rem;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.8px;
		color: var(--bs-secondary-color);
		margin-bottom: 12px;
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.sa-card {
		background: var(--bs-body-bg);
		border: 1px solid var(--bs-border-color);
		border-radius: 12px;
		padding: 16px;
		transition: all 0.2s ease;
		height: 100%;
		position: relative;
		cursor: pointer;
		display: block;
	}

	.sa-card:hover {
		border-color: var(--bs-primary);
		transform: translateY(-2px);
		box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, .06);
	}

	.sa-card.active {
		border-color: var(--bs-primary);
		background: rgba(var(--bs-primary-rgb), 0.04);
		box-shadow: 0 0 0 1px var(--bs-primary);
	}

	.sa-card-header {
		display: flex;
		align-items: flex-start;
		gap: 12px;
		margin-bottom: 8px;
	}

	.sa-icon {
		width: 32px;
		height: 32px;
		border-radius: 8px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 16px;
		flex-shrink: 0;
	}

	.icon-blue {
		background: rgba(var(--bs-primary-rgb), 0.12);
		color: var(--bs-primary);
	}

	.icon-purple {
		background: rgba(var(--bs-info-rgb), 0.12);
		color: var(--bs-info);
	}

	.icon-orange {
		background: rgba(var(--bs-warning-rgb), 0.15);
		color: var(--bs-warning-text-emphasis);
	}

	.icon-green {
		background: rgba(var(--bs-success-rgb), 0.12);
		color: var(--bs-success);
	}

	.sa-title {
		font-weight: 600;
		font-size: 0.95rem;
		color: var(--bs-heading-color);
		line-height: 1.2;
	}

	.sa-desc {
		font-size: 0.8rem;
		color: var(--bs-secondary-color);
		line-height: 1.4;
		margin-left: 44px;
	}

	.sa-inputs {
		margin-top: 12px;
		padding-top: 12px;
		border-top: 1px dashed var(--bs-border-color);
		margin-left: 4px;
		animation: fadeIn 0.2s ease-in-out;
	}

	.sa-check-circle {
		width: 20px;
		height: 20px;
		border: 2px solid var(--bs-border-color);
		border-radius: 50%;
		margin-left: auto;
		position: relative;
		transition: all 0.2s;
	}

	.sa-card.active .sa-check-circle {
		border-color: var(--bs-primary);
		background: var(--bs-primary);
	}

	.sa-card.active .sa-check-circle::after {
		content: "‚úì";
		color: #fff;
		font-size: 12px;
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
	}

	.sa-input-group {
		background: var(--bs-body-bg);
		border: 1px solid var(--bs-border-color);
		border-radius: 8px;
		overflow: hidden;
		display: flex;
		align-items: center;
	}

	.sa-input-group span {
		background: var(--bs-tertiary-bg);
		border-right: 1px solid var(--bs-border-color);
		padding: 6px 10px;
		font-size: 0.85rem;
		color: var(--bs-secondary-color);
	}

	.sa-input-group input {
		border: none;
		padding: 6px 10px;
		width: 100%;
		outline: none;
		font-weight: 600;
		color: var(--bs-primary);
		background: transparent;
	}

	.col-selector-wrap {
		background: var(--bs-body-bg);
		border-color: var(--bs-border-color) !important;
		border-radius: 12px;
		padding: 16px;
		height: 100%;
	}

	/* Export Stock Adj modal: allow space for the bottom Download button */
	#exportStockAdjModal .col-selector-wrap {
		height: auto;
	}

	/* ===== Column Picker ===== */
	:root {
		--pm-group-h: 36px;
	}

	.pm-col-hidden {
		display: none !important;
	}

	.pm-col-menu {
		min-width: 420px;
		max-height: calc(100vh - 160px);
		overflow: auto;
		border-radius: 16px;
		border: 1px solid rgba(var(--bs-body-color-rgb), .06);
		box-shadow: 0 .75rem 1.5rem rgba(0, 0, 0, .06);
		/* Keep below Bootstrap modal/backdrop */
		z-index: 1040;
	}

	/* Ensure Bootstrap modals always overlay page floaters */
	.modal-backdrop {
		z-index: 20040 !important;
	}

	.modal {
		z-index: 20050 !important;
	}

	.pm-cols-group-title {
		margin-top: 10px;
		padding-top: 8px;
		border-top: 1px solid rgba(var(--bs-body-color-rgb), .08);
		font-size: 12px;
		font-weight: 800;
		color: var(--bs-secondary-color);
	}

	.pm-cols-item {
		display: flex;
		align-items: center;
		gap: 10px;
		padding: 6px 6px;
	}

	.pm-cols-item input[type="checkbox"] {
		flex: 0 0 auto;
		width: 18px;
		height: 18px;
		margin: 0;
	}

	.pm-cols-item label {
		flex: 1 1 auto;
		user-select: none;
		cursor: pointer;
		margin: 0;
	}

	/* ===== Recommend Badges (‡∏Ç‡πâ‡∏≠ 14) ===== */
	.pm-badge {
		border-radius: 999px;
		padding: .35rem .55rem;
		font-weight: 800;
		border: 1px solid transparent;
		letter-spacing: .1px;
	}

	.pm-badge-ok {
		background: rgba(var(--bs-success-rgb), .14);
		color: rgba(var(--bs-success-rgb), 1);
		border-color: rgba(var(--bs-success-rgb), .25);
	}

	.pm-badge-info {
		background: rgba(var(--bs-primary-rgb), .12);
		color: rgba(var(--bs-primary-rgb), 1);
		border-color: rgba(var(--bs-primary-rgb), .22);
	}

	.pm-badge-orange-subtle {
		background: rgba(253, 126, 20, .16);
		color: #b45309;
		border-color: rgba(253, 126, 20, .30);
	}

	.pm-badge-orange {
		background: rgba(253, 126, 20, 1);
		color: #fff;
		border-color: rgba(253, 126, 20, 1);
	}

	.pm-badge-red-dark {
		background: #8f1d2c;
		color: #fff;
		border-color: #8f1d2c;
	}

	.pm-badge-neutral {
		background: rgba(var(--bs-secondary-rgb), .14);
		color: rgba(var(--bs-secondary-rgb), 1);
		border-color: rgba(var(--bs-secondary-rgb), .25);
	}

	.pm-kpi-active {
		border-color: rgba(var(--bs-primary-rgb), .35) !important;
		box-shadow: 0 0 0 .25rem rgba(var(--bs-primary-rgb), .12);
	}

	/* ===== Master KPI (Dot) ===== */
	/* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î (22x22) ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô */
	.pm-kpi-master-dot {
		position: absolute;
		top: 6px;
		/* ‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏ß‡∏≤ 36px ‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö */
		right: calc(var(--bs-card-spacer-x, 1rem) + 36px + 10px);
		width: 22px;
		height: 22px;
		padding: 0;
		border: 0;
		background: transparent;
		border-radius: 999px;
		z-index: 20;
		cursor: pointer;
	}

	/* ‡∏ß‡∏≤‡∏î ‚Äú‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏°‚Äù ‡∏à‡∏£‡∏¥‡∏á */
	.pm-kpi-master-dot::before {
		content: "";
		width: 12px;
		height: 12px;
		border-radius: 999px;
		border: 2px solid rgba(var(--bs-body-color-rgb), .25);
		background: rgba(var(--bs-body-bg-rgb), 1);
		display: block;
		margin: auto;
		transition: all .15s ease;
	}

	/* hover ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏î‡πâ */
	.pm-kpi-master-dot:hover::before {
		border-color: rgba(var(--bs-success-rgb), .55);
		box-shadow: 0 0 0 3px rgba(var(--bs-success-rgb), .12);
	}

	/* ‡πÄ‡∏õ‡πá‡∏ô Master ‡πÅ‡∏•‡πâ‡∏ß ‚Äú‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Äù */
	.pm-kpi-master-dot.is-master::before {
		border-color: rgba(var(--bs-success-rgb), 1);
		background: rgba(var(--bs-success-rgb), 1);
		box-shadow: 0 0 0 3px rgba(var(--bs-success-rgb), .18);
	}

	/* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Master ‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
	.pm-kpi-master {
		border-color: rgba(var(--bs-success-rgb), .45) !important;
		box-shadow: 0 0 0 1px rgba(var(--bs-success-rgb), .20) !important;
	}

	/* ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ template ‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° legacy ‡∏ó‡∏¥‡πâ‡∏á */
	.pm-kpi-master-btn {
		display: none !important;
	}

	/* ===== Auto Modal: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ ===== */
	.pm-auto-modal {
		max-width: 1200px;
		width: calc(100vw - 40px);
	}

	.pm-auto-rules-wrap {
		max-height: 52vh;
		overflow-y: scroll;
		overflow-x: hidden;
		scrollbar-gutter: stable both-edges;
		padding-right: 18px;
		box-sizing: border-box;
		border: 1px solid rgba(var(--bs-body-color-rgb), .06);
		border-radius: 14px;
		background: rgba(var(--bs-body-bg-rgb), 1);
	}

	.pm-auto-rules-wrap .list-group-item {
		padding-right: 26px;
	}

	.pm-auto-rules-wrap .list-group-item .d-flex.justify-content-between {
		gap: 10px;
		flex-wrap: wrap;
		align-items: flex-start;
	}

	.pm-auto-rules-wrap .list-group-item .d-flex.justify-content-between> :first-child {
		min-width: 0;
	}

	.pm-auto-rules-wrap .list-group-item .fw-semibold,
	.pm-auto-rules-wrap .list-group-item .small {
		white-space: normal;
		word-break: break-word;
		overflow-wrap: anywhere;
	}

	.pm-auto-rules-wrap .list-group-item .badge {
		flex: 0 0 auto;
		margin-left: auto;
	}

	/* ===== Inline Edit (Dashboard) ===== */
	#btnEditProducts {
		border-width: 2px;
		font-weight: 800;
		/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏ó‡∏ô warning ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß) ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏™‡∏µ‡∏à‡∏≤‡∏Å‡∏ò‡∏µ‡∏° */
		color: color-mix(in srgb, rgb(var(--bs-warning-rgb)) 70%, rgb(var(--bs-dark-rgb)) 30%);
		border-color: color-mix(in srgb, rgb(var(--bs-warning-rgb)) 70%, rgb(var(--bs-dark-rgb)) 30%);
	}

	#btnEditProducts:hover {
		background-color: color-mix(in srgb, rgb(var(--bs-warning-rgb)) 78%, rgb(var(--bs-dark-rgb)) 22%);
		border-color: color-mix(in srgb, rgb(var(--bs-warning-rgb)) 78%, rgb(var(--bs-dark-rgb)) 22%);
		color: var(--bs-white);
	}

	#btnEditProducts.pm-edit-on {
		background: rgba(var(--bs-warning-rgb), 1);
		border-color: rgba(var(--bs-warning-rgb), 1);
		color: rgba(var(--bs-dark-rgb), 1);
		box-shadow: 0 .5rem 1.25rem rgba(var(--bs-warning-rgb), .25);
	}

	body.pm-edit-products-on td.pm-editable,
	tbody.pm-edit-mode td.pm-editable {
		outline: 2px dashed rgba(var(--bs-warning-rgb), .95);
		outline-offset: -3px;
		cursor: pointer;
		background: rgba(var(--bs-warning-rgb), .08);
	}

	body.pm-edit-products-on td.pm-editable:hover,
	tbody.pm-edit-mode td.pm-editable:hover {
		outline: 3px solid rgba(var(--bs-warning-rgb), 1);
		background: rgba(var(--bs-warning-rgb), .14);
	}

	.pm-cell-editing {
		outline: 3px solid rgba(var(--bs-warning-rgb), 1) !important;
		background: rgba(var(--bs-warning-rgb), .18) !important;
	}

	.pm-inline-input {
		width: 100%;
		min-width: 90px;
		padding: .2rem .35rem;
		font-size: 12px;
	}

	tr.pm-row-dirty {
		background: rgba(var(--bs-warning-rgb), .10) !important;
	}

	tr.pm-row-dirty td[data-col="updated"] {
		background: rgba(var(--bs-warning-rgb), .14) !important;
	}

	.pm-save-badge {
		display: inline-block;
		margin-left: 6px;
		padding: 2px 8px;
		border-radius: 999px;
		font-size: 11px;
		font-weight: 800;
		background: rgba(var(--bs-warning-rgb), 1);
		color: rgba(var(--bs-dark-rgb), 1);
	}

	/* ===== Sort controls (server-side) ===== */
	.pm-sort-th .pm-sort-ctrl {
		display: inline-flex;
		gap: 6px;
		margin-left: 8px;
	}

	.pm-sort-link {
		color: rgba(var(--bs-body-color-rgb), .45);
		text-decoration: none;
		font-size: 14px;
		padding: 0 2px;
	}

	.pm-sort-link:hover {
		color: rgba(var(--bs-primary-rgb), 1);
	}

	.pm-sort-link.active {
		color: rgba(var(--bs-primary-rgb), 1);
	}

	.pm-sort-th:hover .pm-sort-link {
		color: rgba(var(--bs-body-color-rgb), .70);
	}

	/* ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
	.pm-sort-th .pm-sort-one {
		margin-left: 6px;
		font-size: 12px;
		padding: 0;
		line-height: 1;
	}

	/* ‚úÖ Header: ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á + ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô sort ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤ */
	.pm-th-inner {
		display: grid;
		grid-template-columns: 1fr auto 1fr;
		/* ‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡πâ‡∏ô | ‡∏Å‡∏•‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠ | ‡∏Ç‡∏ß‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
		align-items: center;
		width: 100%;
	}

	.pm-th-label {
		grid-column: 2;
		justify-self: center;
		text-align: center;
		line-height: 1.1;
	}

	.pm-th-sort {
		grid-column: 3;
		justify-self: end;
	}

	/* ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤/‡∏ï‡∏•‡∏≤‡∏î..." ‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà center */
	.pm-group-row th {
		text-align: center !important;
	}
</style>

<div id="pmPageWrap">

	{% macro sort_th(label, col, kind, classes='') %}
	{% set active = (sort_sel==col) %}
	{% set cur_dir = (sort_dir if active else 'asc') %}
	{% set next_dir = 'desc' if (active and cur_dir=='asc') else 'asc' %}

	{# icon: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏¥‡∏® ‚Äú‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù ‡∏ñ‡πâ‡∏≤ active, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà active ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö asc #}
	{% if kind=='text' %}
	{% set icon = 'bi-sort-alpha-down' if (not active or cur_dir=='asc') else 'bi-sort-alpha-up' %}
	{% elif kind=='num' %}
	{% set icon = 'bi-sort-numeric-down' if (not active or cur_dir=='asc') else 'bi-sort-numeric-up' %}
	{% elif kind=='date' %}
	{% set icon = 'bi-sort-down' if (not active or cur_dir=='asc') else 'bi-sort-up' %}
	{% else %}
	{% set icon = 'bi-arrow-down-up' %}
	{% endif %}

	{# ‚úÖ ‡∏•‡πâ‡∏≤‡∏á class ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô text-end / text-start / text-center ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö header ‡πÉ‡∏´‡πâ center ‡πÄ‡∏™‡∏°‡∏≠ #}
	{% set classes2 = (classes|replace('text-end','')|replace('text-start','')|replace('text-center','')) %}

	<th data-col="{{ col }}" class="pm-sort-th text-center {{ classes2 }}">
		<div class="pm-th-inner">
			<span class="pm-th-label">{{ label }}</span>
			<a class="pm-sort-link pm-sort-one pm-th-sort {% if active %}active{% endif %}"
				href="{{ url_for('price_dashboard', platform=platform, q=q, owner=owner_sel, limit=limit_sel, stale_days=stale_days_sel, kpi=kpi_sel, master=master_sel, sort=col, dir=next_dir) }}"
				title="{% if not active %}‡πÄ‡∏£‡∏µ‡∏¢‡∏á{% else %}{% if cur_dir=='asc' %}‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô DESC{% else %}‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ASC{% endif %}{% endif %}">
				<i class="bi {{ icon }}"></i>
			</a>
		</div>
	</th>
	{% endmacro %}

	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
		<div>
			<div class="page-title d-flex align-items-center">
				<div class="pm-title-icon me-3">üí∞</div>
				<div class="d-flex align-items-baseline flex-wrap">
					<div class="page-title-main me-3">Dashboard Price Marketing</div>
					<div class="text-muted pm-subtitle" style="font-size: 1rem;">
						‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£
					</div>
				</div>
			</div>
		</div>

		<div class="d-flex gap-2">
			<div class="dropdown">
				<button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
					data-bs-auto-close="outside" aria-expanded="false">
					<i class="bi bi-columns-gap me-1"></i>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
				</button>

				<div class="dropdown-menu dropdown-menu-end p-3 pm-col-menu">
					<div class="d-flex justify-content-between align-items-center mb-2">
						<strong>‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</strong>
						<div class="btn-group btn-group-sm">
							<button type="button" class="btn btn-light border" id="pmColsAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
							<button type="button" class="btn btn-light border" id="pmColsReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
						</div>
					</div>

					<div id="pmColsList"></div>

					<div class="mt-2 small text-muted">
						‡∏ó‡∏¥‡∏õ: ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô Voucher/MALL/URL/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•) ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
					</div>
				</div>
			</div>

			<button class="btn btn-outline-warning" type="button" id="btnEditProducts">
				<i class="bi bi-pencil-square me-1"></i>Edit ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
			</button>

			<a class="btn btn-outline-success"
				href="{{ url_for('price_dashboard_export', platform=platform, q=q, owner=owner_sel, limit=limit_sel, stale_days=stale_days_sel, kpi=kpi_sel, master=master_sel) }}">
				<i class="bi bi-file-earmark-excel me-1"></i>Export Excel
			</a>
			<button class="btn btn-outline-success" type="button" data-bs-toggle="modal"
				data-bs-target="#exportPriceModal">
				<i class="bi bi-download me-1"></i>Export Price Sale
			</button>
			<button class="btn btn-outline-success" type="button" data-bs-toggle="modal"
				data-bs-target="#exportStockAdjModal">
				<i class="bi bi-file-earmark-excel me-1"></i>Ex. Price Stock Adj.
			</button>
			<button class="btn btn-outline-primary" type="button" data-bs-toggle="modal"
				data-bs-target="#importPlatformModal">
				<i class="bi bi-upload me-1"></i>Import platform
			</button>
			<a class="btn btn-light border"
				href="{{ url_for('price_dashboard', platform=platform, q=q, owner=owner_sel, limit=limit_sel, stale_days=stale_days_sel, kpi=kpi_sel, master=master_sel, clear_sort=1) }}">
				‡∏•‡πâ‡∏≤‡∏á Sort
			</a>
			<button class="btn btn-outline-primary" type="button" data-bs-toggle="modal"
				data-bs-target="#autoPriceModal">
				<i class="bi bi-lightning-charge me-1"></i>‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤(Auto)
			</button>
			<a class="btn btn-outline-secondary" href="{{ url_for('price_settings') }}">
				<i class="bi bi-gear me-1"></i>Settings
			</a>
		</div>
	</div>

	<div class="modal fade" id="autoPriceModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-xl pm-auto-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><i class="bi bi-lightning-charge me-1"></i>‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ (Auto)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form id="autoPriceForm" method="post" action="{{ url_for('price_dashboard_auto_price_apply') }}">
					<div class="modal-body">
						<input type="hidden" name="platform" value="{{ platform }}">
						<input type="hidden" name="q" value="{{ q }}">
						<input type="hidden" name="owner" value="{{ owner_sel or '' }}">
						<input type="hidden" name="limit" value="{{ limit_sel or '200' }}">
						<input type="hidden" name="stale_days" value="{{ stale_days_sel }}">
						<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
						<input type="hidden" name="master" value="{{ master_sel or '' }}">
						<input type="hidden" name="sort" value="{{ sort_sel or '' }}">
						<input type="hidden" name="dir" value="{{ sort_dir or 'asc' }}">
						<input type="hidden" name="rules" id="pmAutoRules" value="">
						<input type="hidden" name="r9_cfg" id="pmR9Cfg" value="">
						<input type="hidden" name="r10_cfg" id="pmR10Cfg" value="">
						<input type="hidden" name="r11_cfg" id="pmR11Cfg" value="">

						<div class="alert alert-warning mb-3">
							<div class="fw-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö <strong>Our Price</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
							<div class="small">‡∏Ç‡πâ‡∏≠ 1‚Äì7: ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö <strong>Market(best)</strong> | ‡∏Ç‡πâ‡∏≠ 8:
								‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö <strong>Brand Control</strong> (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Market(best) = Brand Control)
								| ‡∏Ç‡πâ‡∏≠ 9: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î ‚Üí ‡∏ï‡∏±‡πâ‡∏á <strong>Our Price</strong> ‡∏à‡∏≤‡∏Å <strong>Cost</strong>
								‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö) | ‡∏Ç‡πâ‡∏≠ 10: ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô &lt; -X% (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å ‚Üí Our
								Price = Cost*(1+|loss|%) (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô 0/5) | ‡∏Ç‡πâ‡∏≠ 11: Priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ï‡∏±‡πâ‡∏á Min/Max)
								‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ loss ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á | ‡∏Ç‡πâ‡∏≠ 12: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ Market(best) &gt; Our Price
								‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡πÑ‡∏£</div>
							<div class="small">‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö ‚Äú‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‚Äù (SKU
								‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Å‡πá‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö)</div>
						</div>

						<div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
							<div class="small text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
							<div class="btn-group btn-group-sm">
								<button type="button" class="btn btn-light border" id="pmAutoAll">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
								<button type="button" class="btn btn-light border" id="pmAutoClear">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
							</div>
						</div>

						<div class="pm-auto-rules-wrap">
							<div class="list-group">
								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r1">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 1: ‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Cost)</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r1') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match ‚â• 0
											‡πÅ‡∏•‡∏∞ Cost &gt; 0</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r2">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 2: Cost = 0 ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r2') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match ‚â• 0
											‡πÅ‡∏•‡∏∞ Cost = 0 ‡πÅ‡∏•‡∏∞ Stock Internal &gt; 0</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r3">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 3: ‡∏¢‡∏≠‡∏°‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Aging ‚â• 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
												‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r3') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt;
											0 ‡πÅ‡∏•‡∏∞ (Aging ‚â• 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢)</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r4">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 4: ‡∏¢‡∏≠‡∏°‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Aging ‚â• 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
												‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r4') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt;
											0 ‡πÅ‡∏•‡∏∞ (Aging ‚â• 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢)</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r5">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 5: ‡∏¢‡∏≠‡∏°‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Aging ‚â• 1 ‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
											</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r5') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt;
											0 ‡πÅ‡∏•‡∏∞ (Aging ‚â• 1 ‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢)</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r6">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 6: ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (0‚Äì5%)</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r6') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt;
											0 ‡πÅ‡∏•‡∏∞ ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô(0-5%)</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r7">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 7: ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô 6‚Äì10% ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏≠‡∏á</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r7') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt;
											0 ‡πÅ‡∏•‡∏∞ ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô(6-10%) ‡πÅ‡∏•‡∏∞ Stock Internal &gt; 0</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r8">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 8: Brand Control (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Market(best) =
												Brand Control)</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r8') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">Market(best) = Brand Control ‡πÅ‡∏•‡∏∞ Market(best) &lt;
											Our Price</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r9">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 9: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î ‚Üí ‡∏ï‡∏±‡πâ‡∏á Our Price ‡∏à‡∏≤‡∏Å Cost (+%
												‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á)</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r9') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted" id="pmR9Desc">
											Market(best) ‡∏ß‡πà‡∏≤‡∏á/0 ‡πÅ‡∏•‡∏∞ Cost: (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤...)
										</div>

										<div class="mt-2 p-2 rounded-3 border bg-body-tertiary" id="pmR9CfgBox">
											<div class="row g-2">
												{% for lo, hi, pct in
												[(5,10,200),(11,20,150),(21,49,120),(50,99,80),(100,499,50),(500,699,45),(700,999,40),(1000,None,35)]
												%}
												<div class="col-6 col-md-3">
													<label class="form-label small mb-1">Cost {{ lo }}{% if hi %}‚Äì{{ hi
														}}{% else %}+{% endif %}</label>
													<div class="input-group input-group-sm">
														<input type="number" step="0.1" min="0" max="500"
															class="form-control pm-r9-pct" data-min="{{ lo }}"
															data-max="{{ hi if hi else '' }}" value="{{ pct }}">
														<span class="input-group-text">%</span>
													</div>
												</div>
												{% endfor %}
											</div>

											<div class="d-flex justify-content-between align-items-center mt-2">
												<div class="small text-muted" id="pmR9SaveStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
												<button type="button" class="btn btn-sm btn-light border"
													id="pmR9ResetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
											</div>

											<div class="small text-muted mt-1">
												* ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‡∏ï‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏±‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö (1‚Äì4 ‡∏•‡∏á,
												5‚Äì9 ‡∏Ç‡∏∂‡πâ‡∏ô)
											</div>
										</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r10">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 10: ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô &lt; -X% (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ) + ‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å ‚Üí
												‡∏ï‡∏±‡πâ‡∏á Our Price ‡∏à‡∏≤‡∏Å Cost*(1+|loss|%)</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r10') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">
											Market(best) &lt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match &lt; -X% ‡πÅ‡∏•‡∏∞ (Stock Internal
											&gt; 0 ‡∏´‡∏£‡∏∑‡∏≠ Stock &gt; 0) ‡πÅ‡∏•‡∏∞ Cost &gt; 0 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Aging
											‚Üí Our Price = Cost*(1+|loss|%) (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0/5)
										</div>

										<div class="mt-2 p-2 rounded-3 border bg-body-tertiary" id="pmR10CfgBox">
											<div class="row g-2 align-items-end">
												<div class="col-12 col-md-4">
													<label class="form-label small mb-1">Min Loss (X%)</label>
													<div class="input-group input-group-sm">
														<input type="number" step="0.1" min="0" max="50"
															class="form-control" id="pmR10MinLoss" value="5">
														<span class="input-group-text">%</span>
													</div>
												</div>
												<div class="col-12 col-md-8">
													<div class="small text-muted" id="pmR10SaveStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
													</div>
													<div class="small text-muted">* ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å &gt;
														0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
												</div>
											</div>
										</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r11">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 11: Priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á Min..Max)
											</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r11') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">
											‡∏ñ‡πâ‡∏≤ |loss| ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á Min..Max ‚Üí Our Price = Market(best)
											‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô Max ‚Üí Our Price = Cost*(1+|loss|%) (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô 0/5)
										</div>

										<div class="mt-2 p-2 rounded-3 border bg-body-tertiary" id="pmR11CfgBox">
											<div class="row g-2 align-items-end">
												<div class="col-6 col-md-3">
													<label class="form-label small mb-1">Min Loss</label>
													<div class="input-group input-group-sm">
														<input type="number" step="0.1" min="0" max="50"
															class="form-control" id="pmR11MinLoss" value="5">
														<span class="input-group-text">%</span>
													</div>
												</div>
												<div class="col-6 col-md-3">
													<label class="form-label small mb-1">Max Loss</label>
													<div class="input-group input-group-sm">
														<input type="number" step="0.1" min="0" max="80"
															class="form-control" id="pmR11MaxLoss" value="20">
														<span class="input-group-text">%</span>
													</div>
												</div>
												<div class="col-12 col-md-6">
													<div class="small text-muted" id="pmR11SaveStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
													</div>
												</div>
											</div>
										</div>
									</div>
								</label>

								<label class="list-group-item d-flex gap-2 align-items-start">
									<input class="form-check-input mt-1 pm-auto-rule" type="checkbox" value="r12">
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between gap-2">
											<div class="fw-semibold">‡∏Ç‡πâ‡∏≠ 12: ‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤ + ‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡πÑ‡∏£ ‚Üí
												‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î</div>
											<span class="badge bg-primary-subtle text-primary">{{
												(auto_change_counts.get('r12') if auto_change_counts is defined else 0)
												}}</span>
										</div>
										<div class="small text-muted">
											Market(best) &gt; Our Price ‡πÅ‡∏•‡∏∞ Profit@Match ‚â• 0 ‡πÅ‡∏•‡∏∞ Cost &gt; 0 ‡πÅ‡∏•‡∏∞ (Stock
											Internal &gt; 0 ‡∏´‡∏£‡∏∑‡∏≠ Stock &gt; 0)
											‚Üí Our Price = Market(best)
										</div>
									</div>
								</label>
							</div>
						</div>

						<div class="mt-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
							<div>
								<div class="fw-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: <span id="pmAutoMatched" class="pm-num">0</span>
								</div>
								<div class="fw-semibold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á: <span id="pmAutoTotal" class="pm-num">0</span>
								</div>
								<div class="small text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ</div>
								<div id="pmAutoR9Preview" class="small text-muted mt-1 d-none"></div>
							</div>
							<div class="small text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span
									class="pm-num">{{ auto_any_count or 0 }}</span></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-light border" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
						<button type="submit" class="btn btn-primary" id="pmAutoConfirm"
							disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="exportPriceModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<form method="get" action="{{ url_for('price_dashboard_export_price') }}" target="_blank">
					<div class="modal-header">
						<h5 class="modal-title"><i class="bi bi-download me-1"></i>Export Price - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<div class="modal-body">
						<input type="hidden" name="platform" value="{{ platform }}">
						<input type="hidden" name="q" value="{{ q }}">
						<input type="hidden" name="owner" value="{{ owner_sel or '' }}">
						<input type="hidden" name="limit" value="{{ limit_sel or '200' }}">
						<input type="hidden" name="stale_days" value="{{ stale_days_sel }}">
						<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
						<input type="hidden" name="master" value="{{ master_sel or '' }}">

						<div class="d-flex justify-content-between align-items-center mb-2">
							<div class="small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel</div>
							<div class="btn-group btn-group-sm">
								<button type="button" class="btn btn-light border" id="expColsAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
								<button type="button" class="btn btn-light border" id="expColsNone">‡∏•‡πâ‡∏≤‡∏á</button>
								<button type="button" class="btn btn-outline-primary" id="expColsSavePref">
									<i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
								</button>
								<button type="button" class="btn btn-outline-danger" id="expColsClearPref">
									<i class="bi bi-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
								</button>
							</div>
						</div>
						<span id="expColsPrefStatus" class="small text-muted"></span>

						<div class="d-flex flex-wrap gap-3 mb-2">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" id="expSortBrand" name="sort_brand"
									value="1" checked>
								<label class="form-check-label" for="expSortBrand">‡πÄ‡∏£‡∏µ‡∏¢‡∏á Brand A-Z</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" id="expIncludeZeroStock"
									name="include_zero_stock" value="1">
								<label class="form-check-label" for="expIncludeZeroStock">Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏° Stock =
									0/‡∏ß‡πà‡∏≤‡∏á)</label>
							</div>
						</div>
						<div id="exportColsList" class="row row-cols-2 g-1"></div>
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
						<button type="submit" class="btn btn-success">Download</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="exportStockAdjModal" tabindex="-1" aria-hidden="true"
		data-dashboard-platform="{{ platform }}">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<form method="get" action="{{ url_for('price_dashboard_export_stock_adj') }}" target="_blank">
					<div class="modal-header border-bottom-0 pb-2">
						<div>
							<h5 class="modal-title fw-bold">
								<i class="bi bi-file-earmark-excel-fill text-success me-2"></i>Export Price &amp; Stock
								Adj.
							</h5>
							<div class="text-muted small mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div>
						</div>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<div class="modal-body bg-body-tertiary p-4">
						<input type="hidden" name="platform" value="{{ platform }}">
						<input type="hidden" name="q" value="{{ q }}">
						<input type="hidden" name="owner" value="{{ owner_sel or '' }}">
						<input type="hidden" name="limit" value="{{ limit_sel or '200' }}">
						<input type="hidden" name="stale_days" value="{{ stale_days_sel }}">
						<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
						<input type="hidden" name="master" value="{{ master_sel or '' }}">

						<div class="row g-4">
							<div class="col-lg-7">
								<div class="sa-section-title"><i class="bi bi-sliders"></i> Basic Settings</div>
								<div class="card border-0 shadow-sm mb-4">
									<div class="card-body">
										<div class="row g-3">
											<div class="col-md-6">
												<label class="form-label small fw-bold text-muted">Platform
													‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
												<select class="form-select form-select-sm" name="adj_platform"
													id="adjPlatformSelect">
													<option value="" selected>‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Dashboard ({{ platform }})
													</option>
													{% for key, label in platforms %}
													<option value="{{ key }}">{{ label }}</option>
													{% endfor %}
													<option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
												</select>
												<input class="form-control form-control-sm mt-2 d-none"
													name="adj_platform_other" id="adjPlatformOtherInput"
													placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...">
											</div>
											<div class="col-md-6">
												<label class="form-label small fw-bold text-muted">‡∏õ‡∏£‡∏±‡∏ö Our Price
													(%)</label>
												<div class="sa-input-group">
													<span><i class="bi bi-percent"></i></span>
													<input type="number" step="0.1" min="-50" max="50" name="adj_pct"
														value="0" placeholder="0">
												</div>
												<div class="text-muted" style="font-size: 10px; margin-top: 4px;">
													+‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (x4‚Üíx5), -‡∏õ‡∏±‡∏î‡∏•‡∏á (x6‚Üíx5)</div>
											</div>

											<!-- ‚úÖ Additional conditions: align under Platform / Our Price -->
											<div class="col-12">
												<div class="row g-2">
													<!-- LEFT (under Platform) -->
													<div class="col-12 col-md-6">
														<div class="p-2 rounded-3 border bg-body-tertiary h-100">
															<div class="small fw-bold text-muted mb-2">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
															</div>

															<!-- Use Sell 1 as base price -->
															<div class="form-check" style="font-size: 12px;">
																<input type="hidden" name="use_sell1" value="0">
																<input class="form-check-input" type="checkbox"
																	id="useSell1Base" name="use_sell1" value="1">
																<label class="form-check-label" for="useSell1Base">
																	‡πÉ‡∏ä‡πâ ‚Äú‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 1 (Sell 1)‚Äù ‡πÅ‡∏ó‡∏ô Our Price ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Export
																</label>
																<div class="text-muted"
																	style="font-size: 11px; margin-left: 1.35rem;">
																	* Sell 1 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Export Price Settings (Step/Min
																	Profit/Aging Loss) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏≠‡∏≤ % ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Sell 1
																</div>
															</div>

															<!-- Skip adj when Profit@Our >= X% -->
															<div class="form-check mt-2" style="font-size: 12px;">
																<input type="hidden" name="skip_adj_when_profit_our"
																	value="0">
																<input class="form-check-input" type="checkbox"
																	id="skipAdjWhenProfitOur"
																	name="skip_adj_when_profit_our" value="1">
																<label class="form-check-label"
																	for="skipAdjWhenProfitOur">
																	‡∏ñ‡πâ‡∏≤ Profit@Our ‚â•
																</label>

																<div class="input-group input-group-sm mt-1 ms-4"
																	style="max-width: 180px;">
																	<input type="number" step="0.1" min="0" max="50"
																		class="form-control" id="profitOurMinPct"
																		name="profit_our_min_pct" value="10">
																	<span class="input-group-text">%</span>
																</div>

																<div class="text-muted"
																	style="font-size: 11px; margin-left: 1.35rem;">
																	* ‡πÉ‡∏ä‡πâ Profit@Our ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Dashboard Price Marketing
																	(‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)<br>
																	* ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ ‚Äú% ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å‚Äù (‡∏ö‡∏ß‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
																	‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≠‡∏ô -%
																</div>
															</div>
														</div>
													</div>

													<!-- RIGHT (under Our Price) -->
													<div class="col-12 col-md-6">
														<div class="p-2 rounded-3 border bg-body-tertiary h-100">
															<div class="small fw-bold text-muted mb-2"
																style="opacity:0;">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>

															<!-- Skip adj when Brand Control > 0 (use Our Price only) -->
															<div class="form-check" style="font-size: 12px;">
																<input type="hidden" name="skip_adj_when_brand_control"
																	value="0">
																<input class="form-check-input" type="checkbox"
																	id="skipAdjWhenBrandControl"
																	name="skip_adj_when_brand_control" value="1">
																<label class="form-check-label"
																	for="skipAdjWhenBrandControl">
																	‡∏ñ‡πâ‡∏≤ SKU ‡∏°‡∏µ Brand Control &gt; 0 ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö %
																	‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Sell 1 ‡πÉ‡∏´‡πâ ‚Äú‡∏¢‡∏∂‡∏î Our Price ‡πÄ‡∏î‡∏¥‡∏°‚Äù (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà
																	Brand Control)
																</label>
																<div class="text-muted"
																	style="font-size: 11px; margin-left: 1.35rem;">
																	* ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤‚Äù ‡∏Ç‡∏≠‡∏á SKU ‡∏ó‡∏µ‡πà‡∏°‡∏µ Brand Control
																	‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Our Price ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="d-flex gap-2 mt-3 pt-3 border-top">
											<button type="button" class="btn btn-outline-primary btn-sm"
												id="btnPresetSave">
												<i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
											</button>
											<button type="button" class="btn btn-outline-danger btn-sm"
												id="btnPresetClear">
												<i class="bi bi-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
											</button>
											<span id="presetStatus"
												class="ms-auto small text-muted align-self-center"></span>
										</div>
									</div>
								</div>

								<div class="d-flex justify-content-between align-items-center mb-2">
									<div class="sa-section-title mb-0"><i class="bi bi-magic"></i> Stock Rules Logic
									</div>
									<span class="badge bg-primary-subtle text-primary border border-primary-subtle"
										id="stockAdjCountBadge">Ready</span>
								</div>

								<div class="row g-3">
									<div class="col-12">
										<div class="row g-2">
											<div class="col-md-6">
												<div class="sa-card" id="cardRule1" role="button" tabindex="0">
													<input class="d-none pm-stock-rule" type="checkbox"
														name="stock_rule" value="1" id="stockRule1">
													<div class="sa-card-header">
														<div class="sa-icon icon-blue"><i
																class="bi bi-1-circle-fill"></i></div>
														<div class="flex-grow-1">
															<div class="sa-title">Step 1-3 is 0</div>
															<div class="sa-check-circle"></div>
														</div>
													</div>
													<div class="sa-desc">
														Stock(‡∏£‡∏ß‡∏°Sup) 1-3 &amp; Internal 0<br>
														<span class="text-danger fw-bold">‚Üí ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0</span>
													</div>
												</div>
											</div>

											<div class="col-md-6">
												<div class="sa-card" id="cardRule2" role="button" tabindex="0">
													<input class="d-none pm-stock-rule" type="checkbox"
														name="stock_rule" value="2" id="stockRule2">
													<div class="sa-card-header">
														<div class="sa-icon icon-blue"><i
																class="bi bi-2-circle-fill"></i></div>
														<div class="flex-grow-1">
															<div class="sa-title">Step 1-5 is 1</div>
															<div class="sa-check-circle"></div>
														</div>
													</div>
													<div class="sa-desc">
														Stock 1-5(‡∏£‡∏ß‡∏°Sup) &amp; Internal 1-5<br>
														<span class="text-success fw-bold">‚Üí ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1</span>
													</div>
												</div>
											</div>

											<div class="col-12">
												<div class="sa-card" id="cardRule3" role="button" tabindex="0">
													<input class="d-none pm-stock-rule" type="checkbox"
														name="stock_rule" value="3" id="stockRule3">
													<div class="sa-card-header">
														<div class="sa-icon icon-purple"><i
																class="bi bi-calculator"></i></div>
														<div class="flex-grow-1">
															<div class="sa-title">Global Divide (‡∏´‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
															<div class="sa-check-circle"></div>
														</div>
													</div>
													<div class="sa-desc mb-2">‡πÑ‡∏°‡πà‡∏™‡∏ô Stock(‡∏£‡∏ß‡∏°Sup) ‡∏ô‡∏≥ Internal
														‡∏°‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ</div>
													<div class="sa-inputs logic-card-inputs d-none" id="wrapRule3">
														<div class="d-flex align-items-center gap-2">
															<span class="small fw-bold">‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢:</span>
															<div class="sa-input-group" style="width: 120px;">
																<input type="number" name="stock_divisor" value="3"
																	min="1" max="999999">
															</div>
															<span class="small text-muted">(‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå 1-2 ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô
																0)</span>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>

									<div class="col-12">
										<div class="sa-section-title mt-2 mb-2"><i class="bi bi-tags-fill"></i> Brand
											Overrides (Priority ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</div>
										<div class="row g-2">
											<div class="col-md-6">
												<div class="sa-card" id="cardRule4" role="button" tabindex="0">
													<input class="d-none pm-stock-rule" type="checkbox"
														name="stock_rule" value="4" id="stockRule4">
													<div class="sa-card-header">
														<div class="sa-icon icon-orange"><i
																class="bi bi-x-circle-fill"></i></div>
														<div class="flex-grow-1">
															<div class="sa-title">Set Zero (0)</div>
															<div class="sa-check-circle"></div>
														</div>
													</div>
													<div class="sa-desc">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ Stock ‡πÄ‡∏õ‡πá‡∏ô 0</div>
													<div class="sa-inputs logic-card-inputs d-none" id="wrapRule4">
														<input class="form-control form-control-sm" type="text"
															name="stock_brands_4" placeholder="‡πÄ‡∏ä‡πà‡∏ô BrandA, BrandB">
													</div>
												</div>
											</div>

											<div class="col-md-6">
												<div class="sa-card" id="cardRule5" role="button" tabindex="0">
													<input class="d-none pm-stock-rule" type="checkbox"
														name="stock_rule" value="5" id="stockRule5">
													<div class="sa-card-header">
														<div class="sa-icon icon-green"><i
																class="bi bi-slash-circle-fill"></i></div>
														<div class="flex-grow-1">
															<div class="sa-title">Specific Divide (‡∏´‡∏≤‡∏£)</div>
															<div class="sa-check-circle"></div>
														</div>
													</div>
													<div class="sa-desc">‡∏´‡∏≤‡∏£ Stock Internal ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ</div>
													<div class="sa-inputs logic-card-inputs d-none" id="wrapRule5">
														<input class="form-control form-control-sm mb-2" type="text"
															name="stock_brands_5" placeholder="‡πÄ‡∏ä‡πà‡∏ô BrandC, BrandD">
														<div class="d-flex align-items-center gap-2">
															<span class="small fw-bold">‡∏´‡∏≤‡∏£:</span>
															<div class="sa-input-group" style="width: 80px;">
																<input type="number" name="stock_divisor_brand"
																	value="2" min="1">
															</div>
														</div>

														<!-- NEW: Toggle ‡∏õ‡∏±‡∏î 1‚Äì2 ‡πÄ‡∏õ‡πá‡∏ô 0 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Rule 5) -->
														<div class="form-check mt-2" style="font-size: 12px;">
															<input type="hidden" name="stock_divide_brand_floor12_to0"
																value="0">
															<input class="form-check-input" type="checkbox"
																id="stockDivideBrandFloor12"
																name="stock_divide_brand_floor12_to0" value="1" checked>
															<label class="form-check-label"
																for="stockDivideBrandFloor12">
																‡∏õ‡∏±‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå 1‚Äì2 ‡πÄ‡∏õ‡πá‡∏ô 0
															</label>
														</div>

														<!-- NEW: Toggle ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ 0 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Rule 5) -->
														<div class="form-check mt-1" style="font-size: 12px;">
															<input type="hidden"
																name="stock_divide_brand_min1_when_zero" value="0">
															<input class="form-check-input" type="checkbox"
																id="stockDivideBrandMin1"
																name="stock_divide_brand_min1_when_zero" value="1">
															<label class="form-check-label" for="stockDivideBrandMin1">
																‡∏ñ‡πâ‡∏≤ Internal &gt; 0 ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ 0 ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô 1
																(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å)
															</label>
														</div>

														<div class="text-muted"
															style="font-size: 11px; margin-left: 1.35rem;">
															‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: Internal=1 ‡∏´‡∏≤‡∏£ 2 = 0 ‚Üí ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î ‚Äú‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1‚Äù ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
															1
															<br>‡πÅ‡∏•‡∏∞ Internal=3 ‡∏´‡∏≤‡∏£ 2 = 1 ‚Üí ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡∏ï‡∏¥‡πä‡∏Å‡∏õ‡∏±‡∏î 1‚Äì2
															‡πÄ‡∏õ‡πá‡∏ô 0‚Äù / ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å‚Äù
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<button type="button" class="btn btn-primary w-100 mt-4 py-2 shadow-sm"
									id="btnStockAdjConfirm" style="border-radius: 10px;">
									<i class="bi bi-calculator me-2"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Preview)
								</button>
								<div class="text-center mt-2 small text-muted">
									‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ <span class="fw-bold text-primary" id="stockAdjCount">0</span> SKU
									‡∏à‡∏≤‡∏Å <span id="stockAdjTotal">0</span>
								</div>
							</div>

							<div class="col-lg-5">
								<div class="col-selector-wrap shadow-sm border">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<div class="sa-section-title mb-0"><i class="bi bi-table"></i> Select Columns
										</div>
										<div class="btn-group btn-group-sm">
											<button type="button" class="btn btn-outline-secondary"
												id="adjColsAll">All</button>
											<button type="button" class="btn btn-outline-secondary"
												id="adjColsNone">None</button>
										</div>
									</div>
									<div style="max-height: 600px; overflow-y: auto; padding-right: 4px;">
										<div class="row g-3" id="adjColsContainer"></div>
									</div>
								</div>

								<div class="mt-4 pt-3 border-top text-end">
									<div class="small text-muted mb-2">
										<i class="bi bi-info-circle me-1"></i>
										‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏°‡∏µ: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö / ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö / % ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏°‡∏≠
									</div>
									<button type="submit" class="btn btn-success px-4 py-2 fw-bold shadow-sm"
										style="border-radius: 10px;">
										<i class="bi bi-file-earmark-excel me-2"></i> Download Excel
									</button>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" id="importPlatformModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Import platform (‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Export Price &amp; Stock Adj.)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="imp-card mb-3">
						<div class="imp-step"><span class="dot">1</span> Platform &amp; Setting</div>
						<div class="row g-2 align-items-end">
							<div class="col-md-4">
								<label class="form-label">Platform</label>
								<select class="form-select form-select-sm" id="impPlatform">
									{% for k, label in platforms %}
									<option value="{{k}}">{{label}}</option>
									{% endfor %}
								</select>
							</div>
							<div class="col-md-8">
								<label class="form-label">Setting ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Export Price &amp; Stock Adj.</label>
								<div class="p-3 rounded-3 border bg-body-tertiary" id="impPresetBox">
									<div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
										<div class="small text-muted" id="impPresetStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Setting...</div>
										<span class="badge text-bg-success d-none" id="impPresetOk">Ready</span>
										<span class="badge text-bg-danger d-none" id="impPresetMissing">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
											Setting</span>
									</div>
									<div class="mt-2 d-flex gap-2 flex-wrap" id="impPresetBadges"></div>
									<div class="small text-muted mt-2">
										* Import ‡∏à‡∏∞‡∏¢‡∏∂‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏Ç‡∏≠‡∏á Export Price &amp; Stock Adj. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
									</div>
									<div class="mt-2">
										<button type="button" class="btn btn-sm btn-outline-primary"
											data-bs-toggle="modal" data-bs-target="#exportStockAdjModal">
											‡πÄ‡∏õ‡∏¥‡∏î Export Price &amp; Stock Adj.
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="imp-card">
						<div class="imp-step"><span class="dot">2</span> Upload &amp; Inspect</div>
						<div class="row g-2 align-items-end">
							<div class="col-12">
								<label class="form-label">‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ç‡∏≠‡∏á platform (.xlsx)</label>
								<input class="form-control form-control-sm" type="file" id="impFile" accept=".xlsx">
								<div class="small text-muted mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
									‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å map ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
							</div>
							<div class="col-12 d-flex gap-2">
								<button class="btn btn-sm btn-secondary" id="btnImpInspect"
									type="button">‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
							</div>
						</div>
					</div>

					<div id="impMappingArea" class="d-none">
						<hr>
						<div class="imp-step"><span class="dot">3</span> Mapping &amp; Apply</div>
						<div class="row g-2">
							<div class="col-md-4">
								<label class="form-label">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå SKU (Master)</label>
								<select class="form-select form-select-sm" id="impSkuCol"></select>
							</div>
							<div class="col-md-4" id="impSkuAltWrap" style="display:none;">
								<label class="form-label">Shopee: ‡πÄ‡∏•‡∏Ç SKU</label>
								<select class="form-select form-select-sm" id="impSkuColAlt"></select>
								<div class="small text-muted">‡∏ñ‡πâ‡∏≤ SKU ‡∏´‡∏•‡∏±‡∏Å‡∏ß‡πà‡∏≤‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ SKU ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô</div>
							</div>
							<div class="col-md-4">
								<label class="form-label">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Price (‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)</label>
								<select class="form-select form-select-sm" id="impPriceCol"></select>
							</div>
							<div class="col-md-4" id="impPriceCol2Wrap" style="display:none;">
								<label class="form-label">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Price 2 (Lazada: ‡∏£‡∏≤‡∏Ñ‡∏≤)</label>
								<select class="form-select form-select-sm" id="impPriceCol2"></select>
								<div class="small text-muted">Lazada ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö Special Price ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô</div>
							</div>
							<div class="col-md-4">
								<label class="form-label">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Stock (‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)</label>
								<select class="form-select form-select-sm" id="impStockCol"></select>
							</div>
						</div>

						<div class="d-flex justify-content-between align-items-center mt-2">
							<div class="small text-muted">* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï price/stock ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú(‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)‚Äù</div>
							<div class="small text-muted" id="impMapStatus"></div>
						</div>
						<div class="mt-2">
							<button class="btn btn-sm btn-outline-danger" type="button" id="btnImpMapClear">
								‡∏•‡πâ‡∏≤‡∏á Mapping ‡∏Ç‡∏≠‡∏á Platform ‡∏ô‡∏µ‡πâ
							</button>
						</div>

						<div class="d-flex gap-2 mt-3">
							<button class="btn btn-sm btn-primary" id="btnImpApply" type="button"
								disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>
							<a class="btn btn-sm btn-success disabled" id="btnImpDownload" href="#"
								target="_blank">Download ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</a>
						</div>

						<div class="mt-3">
							<div class="progress" style="height: 18px;">
								<div class="progress-bar" id="impProgress" style="width:0%">0%</div>
							</div>
							<div class="mt-2 small" id="impStats"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="card shadow-sm border-0 mb-4 pm-control-card">
		<div class="card-body bg-light">
			<div class="row g-2 align-items-end">
				<div class="col-md-3">
					<div class="d-flex align-items-center justify-content-between gap-2">
						<label class="form-label small text-muted mb-0">Platform</label>

						<div class="pm-platform-pills">
							<span id="platformHint" class="pm-lock-pill">
								üîí <strong>{{ platform }}</strong>
							</span>

							<span class="pm-fee-pill">
								‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: <strong>{{ fee.fee_pct }}%</strong> + <strong>{{ fee.fixed_fee }}</strong>
								‡∏ö‡∏≤‡∏ó/‡∏ä‡∏¥‡πâ‡∏ô
							</span>
						</div>
					</div>

					<form id="platformLockForm" method="post" action="{{ url_for('price_dashboard_set_platform') }}">
						<input type="hidden" name="q" value="{{ q }}">
						<input type="hidden" name="owner" value="{{ owner_sel or '' }}">
						<input type="hidden" name="limit" value="{{ limit_sel or '200' }}">
						<input type="hidden" name="stale_days" value="{{ stale_days_sel }}">
						<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
						<input type="hidden" name="master" value="{{ master_sel or '' }}">
						<input type="hidden" name="sort" value="{{ sort_sel or '' }}">
						<input type="hidden" name="dir" value="{{ sort_dir or 'asc' }}">

						<div class="pm-platform-left mt-2">
							<select id="platformSelect" class="form-select" name="platform" disabled>
								{% for key, label in platforms %}
								<option value="{{ key }}" {% if platform==key %}selected{% endif %}>{{ label }}</option>
								{% endfor %}
							</select>
							<button id="btnEditPlatform" type="button" class="btn btn-outline-secondary">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
							<button id="btnSavePlatform" type="submit" class="btn btn-primary d-none">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
							<button id="btnCancelPlatform" type="button"
								class="btn btn-light border d-none">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
						</div>
					</form>
				</div>

				<div class="col-md-9">
					<div class="d-flex justify-content-end">
						<form id="filterLockForm" class="pm-filter-form" method="post"
							action="{{ url_for('price_dashboard_set_filters') }}">
							<input type="hidden" name="platform" value="{{ platform }}">
							<input type="hidden" name="q" value="{{ q }}">
							<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
							<input type="hidden" name="master" value="{{ master_sel or '' }}">
							<input type="hidden" name="sort" value="{{ sort_sel or '' }}">
							<input type="hidden" name="dir" value="{{ sort_dir or 'asc' }}">

							<div class="row g-2 align-items-end">
								<div class="col-lg-4">
									<label class="form-label small text-muted">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
									<select id="ownerSelect" class="form-select" name="owner" disabled>
										<option value="" {% if not owner_sel %}selected{% endif %}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
										{% for o in owners_list or [] %}
										<option value="{{ o }}" {% if owner_sel==o %}selected{% endif %}>{{ o }}
										</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-lg-3">
									<label class="form-label small text-muted">‡πÅ‡∏™‡∏î‡∏á</label>
									<select id="limitSelect" class="form-select" name="limit" disabled>
										{% for v in ["100","200","300","500","1000","all"] %}
										<option value="{{ v }}" {% if limit_sel==v %}selected{% endif %}>{{ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" if
											v=="all" else v }}</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-lg-3">
									<label class="form-label small text-muted">Update ‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)</label>
									<select class="form-select" id="staleDaysSelect" name="stale_days" disabled>
										{% for v in ["7","14","30","60","90"] %}
										<option value="{{ v }}" {% if stale_days_sel==v %}selected{% endif %}>{{ v }}
											‡∏ß‡∏±‡∏ô</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-lg-2 pm-filter-actions">
									<button id="btnEditFilters" type="button"
										class="btn btn-outline-secondary">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
									<button id="btnSaveFilters" type="submit"
										class="btn btn-primary d-none">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
									<button id="btnCancelFilters" type="button"
										class="btn btn-light border d-none">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
								</div>
							</div>
						</form>
					</div>

					<form id="searchForm" method="get" action="{{ url_for('price_dashboard') }}" class="mt-2">
						<input type="hidden" name="platform" value="{{ platform }}">
						<input type="hidden" name="owner" value="{{ owner_sel or '' }}">
						<input type="hidden" name="limit" value="{{ limit_sel or '200' }}">
						<input type="hidden" name="stale_days" value="{{ stale_days_sel }}">
						<input type="hidden" name="kpi" value="{{ kpi_sel or '' }}">
						<input type="hidden" name="master" value="{{ master_sel or '' }}">
						<input type="hidden" name="sort" value="{{ sort_sel or '' }}">
						<input type="hidden" name="dir" value="{{ sort_dir or 'asc' }}">
						<div class="row g-2 align-items-end">
							<div class="col-lg-10">
								<label class="form-label small text-muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (SKU / Brand / Name)</label>
								<input class="form-control" name="q" value="{{ q }}"
									placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC123 ‡∏´‡∏£‡∏∑‡∏≠ Canon">
							</div>
							<div class="col-lg-2 d-flex gap-2">
								<button class="btn btn-primary w-100" type="submit"><i class="bi bi-search"></i>
									‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
								<a class="btn btn-light border"
									href="{{ url_for('price_dashboard', platform=platform) }}" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
									<i class="bi bi-x-circle"></i>
								</a>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="row g-3 mb-4">
		{% for c in kpi_cards %}
		<div class="col-6 col-md-3 col-lg-2">
			<div class="card pm-kpi h-100 {% if c.key != 'tracked' %}pm-kpi-hascheck{% endif %} {% if master_sel == c.key %}pm-kpi-master{% endif %} {% if c.key != 'tracked' and (kpi_selected is defined) and (c.key in kpi_selected) %}pm-kpi-active{% endif %}"
				role="button" data-kpi="{{ c.key }}" data-tone="{{ c.tone }}">
				{% if c.key != "tracked" %}
				<button type="button" class="pm-kpi-master-dot {% if master_sel == c.key %}is-master{% endif %}"
					data-master="{{ c.key }}" title="‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Master" aria-label="‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Master"></button>
				{% endif %}
				{% if c.key != "tracked" %}
				<div class="pm-kpi-check">
					{% set _checked = (c.key == master_sel) or ((kpi_selected is defined) and (c.key in kpi_selected))
					%}
					<input class="form-check-input pm-kpi-filter" type="checkbox" data-kpi="{{ c.key }}" {% if _checked
						%}checked{% endif %}>
				</div>
				{% endif %}
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<div class="pm-kpi-label">{{ c.label }}</div>
						<div class="pm-kpi-value pm-num">{{ c.count }}</div>
					</div>
					<div class="pm-kpi-icon"><i class="bi {{ c.icon }}"></i></div>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>

	<div class="card shadow-sm border-0">
		<div class="card-body bg-white">
			<div class="pm-table-wrap">
				<div class="table-responsive pm-table-scroll">
					<table class="table table-sm table-striped align-middle mb-0 pm-table">
						<thead class="table-light">
							<tr class="pm-group-row">
								<th colspan="4" data-group="product">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
								<th colspan="4" class="text-center pm-split-left" data-group="internal">‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤</th>
								<th colspan="2" class="text-center pm-split-left" data-group="market">‡∏ï‡∏•‡∏≤‡∏î</th>
								<th colspan="1" class="text-center pm-split-left" data-group="control">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th>
								<th colspan="3" class="text-center pm-split-left" data-group="profit">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á/‡∏Å‡∏≥‡πÑ‡∏£</th>
								<th colspan="5" class="text-center pm-split-left" data-group="market_detail">
									‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏•‡∏≤‡∏î</th>
								<th colspan="1" class="text-center pm-split-left" data-group="time">‡πÄ‡∏ß‡∏•‡∏≤</th>
							</tr>
							<tr class="pm-col-row">
								{{ sort_th('SKU','sku','text') }}
								{{ sort_th('Brand','brand','text') }}
								{{ sort_th('Name','name','text') }}
								{{ sort_th('Stock Internal','stock_internal','num','text-end') }}
								{{ sort_th('Stock','stock','num','text-end pm-split-left') }}
								{{ sort_th('Monthly Sales','monthly_sales','num','text-end') }}
								{{ sort_th('Cost','cost','num','text-end pm-col-cost pm-split-left') }}
								{{ sort_th('Our Price','our_price','num','text-end pm-col-our') }}
								{{ sort_th('Market (best)','market_best','num','text-end pm-col-market pm-split-left')
								}}
								{{ sort_th('Voucher','voucher','num','text-end') }}
								{{ sort_th('Brand Control','brand_control','num','text-end pm-split-left') }}
								{{ sort_th('Gap','gap','num','text-end pm-split-left') }}
								{{ sort_th('Profit@Our','profit_our','num','text-end') }}
								{{ sort_th('Profit@Match','profit_match','num','text-end') }}
								{{ sort_th('Recommend','recommend','num','pm-split-left') }}
								{{ sort_th('Shop','shop','text') }}
								{{ sort_th('MALL','mall','num','text-center') }}
								{{ sort_th('URL','url','text') }}
								{{ sort_th('‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•','owner','text') }}
								{{ sort_th('Updated','updated','date','pm-split-left') }}
							</tr>
						</thead>
						<tbody id="pmTbody" data-key="{{ dash_key }}" data-total="{{ dash_total_rows }}"
							data-pagesize="{{ dash_page_size }}" data-loaded="{{ rows|length }}">
							{% include "_price_dashboard_rows.html" %}
							{% if dash_total_rows == 0 %}
							<tr>
								<td colspan="20" class="text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
							</tr>
							{% endif %}
						</tbody>
					</table>
					<div id="pmInfiniteSentinel" class="py-3 text-center text-muted">
						<span id="pmInfiniteSpinner" class="spinner-border spinner-border-sm me-2 d-none"></span>
						<span id="pmInfiniteText">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- ‚úÖ Modal: ‡πÅ‡∏Å‡πâ Updated + ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‚Äù -->
	<div class="modal fade" id="pmUpdatedModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Updated)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="small text-muted mb-2">
						‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Market(best)/Voucher/Shop/URL ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î OK ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
					</div>
					<label class="form-label small text-muted">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á
						‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</label>
					<input type="text" class="form-control" id="pmUpdatedInput"
						placeholder="‡πÄ‡∏ä‡πà‡∏ô 23/12/2568 14:30 ‡∏´‡∏£‡∏∑‡∏≠ 2025-12-23 14:30">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-primary" id="pmUpdatedNowBtn">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
					<button type="button" class="btn btn-light border" id="pmUpdatedCancelBtn">Cancel</button>
					<button type="button" class="btn btn-primary" id="pmUpdatedOkBtn">OK</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		(function () {
			const sel = document.getElementById('platformSelect');
			const btnEdit = document.getElementById('btnEditPlatform');
			const btnSave = document.getElementById('btnSavePlatform');
			const btnCancel = document.getElementById('btnCancelPlatform');
			const hint = document.getElementById('platformHint');

			if (!sel || !btnEdit || !btnSave || !btnCancel) return;

			const lockedValue = sel.value;

			function setEditMode(on) {
				sel.disabled = !on;
				btnEdit.classList.toggle('d-none', on);
				btnSave.classList.toggle('d-none', !on);
				btnCancel.classList.toggle('d-none', !on);

				if (hint) {
					hint.classList.toggle('pm-lock-pill', !on);
					hint.classList.toggle('pm-edit-pill', on);
					hint.innerHTML = on
						? '‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Platform (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)'
						: 'üîí <strong>' + lockedValue + '</strong>';
				}
			}

			btnEdit.addEventListener('click', function () {
				setEditMode(true);
			});

			btnCancel.addEventListener('click', function () {
				sel.value = lockedValue;
				setEditMode(false);
			});
		})();
	</script>

	<script>
		(function () {
			// ===== Export Price: Column picker + Save Pref =====
			const PLATFORM = "{{ platform }}";
			const EXPORT_COLS = [
				{ key: 'sku', label: 'SKU' },
				{ key: 'brand', label: 'Brand' },
				{ key: 'name', label: 'Name' },
				{ key: 'spec', label: 'Spec' },
				{ key: 'stock_internal', label: 'Stock Internal' },
				{ key: 'stock', label: 'Stock' },
				{ key: 'monthly_sales', label: 'Monthly Sales' },
				{ key: 'cost', label: 'Cost' },
				{ key: 'our_price', label: 'Our Price' },
				{ key: 'sell_1', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 1' },
				{ key: 'sell_2', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 2' },
				{ key: 'sell_3', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 3' },
				{ key: 'sell_4', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 4' },
				{ key: 'sell_5', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ 5' },
				{ key: 'sell_min', label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î' },
				{ key: 'market_best', label: 'Market (best)' },
				{ key: 'voucher', label: 'Voucher' },
				{ key: 'brand_control', label: 'Brand Control' },
				{ key: 'gap', label: 'Gap' },
				{ key: 'profit_our', label: 'Profit@Our' },
				{ key: 'profit_match', label: 'Profit@Match' },
				{ key: 'recommend', label: 'Recommend' },
				{ key: 'shop', label: 'Shop' },
				{ key: 'mall', label: 'MALL' },
				{ key: 'url', label: 'URL' },
				{ key: 'owner', label: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' },
				{ key: 'updated', label: 'Updated' },
			];

			const wrap = document.getElementById('exportColsList');
			const modal = document.getElementById('exportPriceModal');
			const cbSort = document.getElementById('expSortBrand');
			const cbZero = document.getElementById('expIncludeZeroStock');
			const btnAll = document.getElementById('expColsAll');
			const btnNone = document.getElementById('expColsNone');
			const btnSave = document.getElementById('expColsSavePref');
			const btnClear = document.getElementById('expColsClearPref');
			const st = document.getElementById('expColsPrefStatus');

			const LS_KEY = 'pm_export_price_cols_v1_' + PLATFORM;

			function status(txt) { if (st) st.textContent = txt || ''; }

			function renderExportCols() {
				if (!wrap) return;
				wrap.innerHTML = '';
				EXPORT_COLS.forEach(c => {
					const id = 'exp_' + c.key;
					const col = document.createElement('div');
					col.className = 'col';
					col.innerHTML = `
					<div class="form-check">
						<input class="form-check-input" type="checkbox" name="cols" value="${c.key}" id="${id}">
						<label class="form-check-label" for="${id}">${c.label}</label>
					</div>`;
					wrap.appendChild(col);
				});
			}

			function collectCfg() {
				const cols = Array.from(document.querySelectorAll('#exportColsList input[name="cols"]:checked'))
					.map(cb => cb.value);

				if (cols.length === 0) cols.push('sku');
				if (!cols.includes('sku')) cols.unshift('sku');

				return {
					cols,
					sort_brand: !!cbSort?.checked,
					include_zero_stock: !!cbZero?.checked
				};
			}

			function applyCfg(cfg) {
				const wantList = (cfg && Array.isArray(cfg.cols) && cfg.cols.length)
					? cfg.cols
					: EXPORT_COLS.map(x => x.key);
				const want = new Set(wantList);
				document.querySelectorAll('#exportColsList input[name="cols"]').forEach(cb => {
					cb.checked = want.has(cb.value);
				});
				if (cbSort && cfg && typeof cfg.sort_brand === 'boolean') cbSort.checked = cfg.sort_brand;
				if (cbZero && cfg && typeof cfg.include_zero_stock === 'boolean') cbZero.checked = cfg.include_zero_stock;
			}

			async function loadCfg() {
				try {
					const res = await fetch('/api/price/export_price_cols?platform=' + encodeURIComponent(PLATFORM), { credentials: 'same-origin' });
					const js = await res.json();
					if (js && js.success && js.cfg) {
						status('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
						try { localStorage.setItem(LS_KEY, JSON.stringify(js.cfg)); } catch (e) { }
						return js.cfg;
					}
				} catch (e) { }

				try {
					const raw = localStorage.getItem(LS_KEY);
					if (raw) {
						status('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
						return JSON.parse(raw);
					}
				} catch (e) { }

				status('‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
				return null;
			}

			async function saveCfgNow() {
				const cfg = collectCfg();
				status('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
				try {
					const res = await fetch('/api/price/export_price_cols/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ platform: PLATFORM, cfg })
					});
					const js = await res.json();
					if (js && js.success) {
						status('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
						try { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); } catch (e) { }
						return;
					}
					status('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
				} catch (e) {
					try { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); status('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); } catch (e2) { status('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
				}
			}

			async function clearCfg() {
				status('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á...');
				try {
					const res = await fetch('/api/price/export_price_cols/clear', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ platform: PLATFORM })
					});
					const js = await res.json();
					if (js && js.success) {
						status('‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
						try { localStorage.removeItem(LS_KEY); } catch (e) { }
						applyCfg(null);
						return;
					}
					status('‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
				} catch (e) {
					try { localStorage.removeItem(LS_KEY); } catch (e2) { }
					status('‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
					applyCfg(null);
				}
			}

			let t = null;
			function scheduleAutoSave() {
				clearTimeout(t);
				status('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
				t = setTimeout(saveCfgNow, 500);
			}

			btnAll?.addEventListener('click', () => {
				document.querySelectorAll('#exportColsList input[name="cols"]').forEach(cb => cb.checked = true);
				scheduleAutoSave();
			});
			btnNone?.addEventListener('click', () => {
				document.querySelectorAll('#exportColsList input[name="cols"]').forEach(cb => cb.checked = false);
				const skuCb = document.getElementById('exp_sku');
				if (skuCb) skuCb.checked = true;
				scheduleAutoSave();
			});

			btnSave?.addEventListener('click', saveCfgNow);
			btnClear?.addEventListener('click', clearCfg);

			modal?.addEventListener('change', (e) => {
				if (e.target && (e.target.name === 'cols' || e.target.id === 'expSortBrand' || e.target.id === 'expIncludeZeroStock')) {
					scheduleAutoSave();
				}
			});

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', renderExportCols);
			} else {
				renderExportCols();
			}

			modal?.addEventListener('shown.bs.modal', async () => {
				if (!wrap || wrap.children.length === 0) renderExportCols();
				const cfg = await loadCfg();
				applyCfg(cfg);
			});
		})();
	</script>

	<script>
		(function () {
			const $ = (id) => document.getElementById(id);
			let lastInspect = null;
			let impPreset = null;
			let impMapPreset = null;
			let impMapSaveTimer = null;

			function _platKey() {
				return String($("impPlatform")?.value || "").trim().toLowerCase();
			}

			async function loadImpMapPreset() {
				const p = _platKey();
				impMapPreset = null;
				try {
					const res = await fetch("/api/price/platform_import/mapping?platform=" + encodeURIComponent(p), { credentials: "same-origin" });
					const js = await res.json();
					if (js && js.ok && js.mapping) impMapPreset = js.mapping;
				} catch (e) { }
			}

			function selGet(sel) {
				const i = Number(sel?.value || 0);
				const n = (sel && sel.selectedIndex >= 0) ? (sel.options[sel.selectedIndex].textContent || "").trim() : "";
				return { i, n };
			}

			function selSetByPref(sel, pref) {
				if (!sel || !pref) return false;

				// 1) match by column header name
				const wantName = (pref.n || "").trim().toLowerCase();
				if (wantName) {
					const opt = Array.from(sel.options).find(o => (o.textContent || "").trim().toLowerCase() === wantName);
					if (opt) { sel.value = opt.value; return true; }
				}

				// 2) fallback by index
				const wantIdx = Number(pref.i || 0);
				if (wantIdx > 0) {
					const has = Array.from(sel.options).some(o => Number(o.value) === wantIdx);
					if (has) { sel.value = String(wantIdx); return true; }
				}
				return false;
			}

			async function saveImpMapPresetNow() {
				const p = _platKey();
				const payload = {
					sku: selGet($("impSkuCol")),
					sku2: selGet($("impSkuColAlt")),
					p1: selGet($("impPriceCol")),
					p2: selGet($("impPriceCol2")),
					st: selGet($("impStockCol")),
				};

				try {
					await fetch("/api/price/platform_import/mapping/save", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						credentials: "same-origin",
						body: JSON.stringify({ platform: p, mapping: payload })
					});
					const s = $("impMapStatus");
					if (s) s.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å mapping ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ";
				} catch (e) {
					const s = $("impMapStatus");
					if (s) s.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å mapping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
				}
			}

			function scheduleSaveMapping() {
				clearTimeout(impMapSaveTimer);
				impMapSaveTimer = setTimeout(saveImpMapPresetNow, 400);
			}

			function togglePlatformExtras() {
				const p = _platKey();
				const wrapAlt = $("impSkuAltWrap");
				const wrapP2 = $("impPriceCol2Wrap");
				if (wrapAlt) wrapAlt.style.display = (p === "shopee") ? "" : "none";
				if (wrapP2) wrapP2.style.display = (p === "lazada") ? "" : "none";
			}

			async function loadImpPresetForPlatform(destPlatform) {
				impPreset = null;
				const st = $("impPresetStatus");
				const ok = $("impPresetOk");
				const miss = $("impPresetMissing");
				const btnApply = $("btnImpApply");
				if (st) st.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Setting ‡∏à‡∏≤‡∏Å Export Price & Stock Adj...";
				if (ok) ok.classList.add("d-none");
				if (miss) miss.classList.add("d-none");
				if (btnApply) btnApply.disabled = true;

				function renderPresetBadges(preset) {
					const wrap = $("impPresetBadges");
					if (!wrap) return;
					wrap.innerHTML = "";

					function badge(text, cls) {
						const s = document.createElement("span");
						s.className = "badge rounded-pill " + cls;
						s.textContent = text;
						wrap.appendChild(s);
					}

					const adj = Number((preset || {}).adj_pct || 0);
					badge("Adj: " + (adj >= 0 ? "+" : "") + adj + "%", "text-bg-primary");
					badge("Base: " + ((preset || {}).use_sell1 ? "Sell 1" : "Our Price"), "text-bg-dark");

					const rules = ((preset || {}).stock_rules || []).map(String).join(",");
					badge("Stock Rules: " + (rules || "-"), "text-bg-secondary");

					const ruleSet = new Set(((preset || {}).stock_rules || []).map(String));
					if (ruleSet.has("3")) badge("Divide: " + String((preset || {}).stock_divisor || 3), "text-bg-info");
					if (ruleSet.has("5")) badge("Brand Divide: /" + String((preset || {}).stock_divisor_brand || 2), "text-bg-success");
				}
				try {
					const url = "/api/price/export_preset?dest_platform=" + encodeURIComponent(destPlatform || "");
					const res = await fetch(url, { credentials: "same-origin" });
					const js = await res.json();
					impPreset = (js && js.preset) ? js.preset : null;

					if (!impPreset) {
						if (st) st.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Setting ‡∏Ç‡∏≠‡∏á "${destPlatform}" (‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Export Price & Stock Adj. ‡∏Å‡πà‡∏≠‡∏ô)`;
						if (miss) miss.classList.remove("d-none");
						renderPresetBadges({ adj_pct: 0, use_sell1: false, stock_rules: [] });
						return;
					}

					if (st) st.textContent = `‡πÉ‡∏ä‡πâ Setting ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏Ç‡∏≠‡∏á "${destPlatform}" ‡πÅ‡∏•‡πâ‡∏ß`;
					if (ok) ok.classList.remove("d-none");
					if (btnApply) btnApply.disabled = false;
					renderPresetBadges(impPreset);
				} catch (e) {
					if (st) st.textContent = "‡πÇ‡∏´‡∏•‡∏î Setting ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤)";
					if (miss) miss.classList.remove("d-none");
				}
			}

			function setProgress(p) {
				const bar = $("impProgress");
				if (!bar) return;
				bar.style.width = p + "%";
				bar.textContent = p + "%";
			}

			function fillSelect(sel, cols, allowNone) {
				sel.innerHTML = "";
				if (allowNone) {
					const opt0 = document.createElement("option");
					opt0.value = "0";
					opt0.textContent = "(‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)";
					sel.appendChild(opt0);
				}
				(cols || []).forEach(c => {
					const opt = document.createElement("option");
					opt.value = String(c.idx);
					opt.textContent = c.name;
					sel.appendChild(opt);
				});
			}

			$("btnImpInspect")?.addEventListener("click", async () => {
				const file = $("impFile")?.files?.[0];
				if (!file) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå"); return; }

				setProgress(0);
				if ($("impStats")) $("impStats").textContent = "";

				const fd = new FormData();
				fd.append("file", file);
				fd.append("platform", $("impPlatform")?.value || "");

				const res = await fetch("/api/price/platform_import/inspect", {
					method: "POST",
					body: fd,
					credentials: 'same-origin'
				});
				const js = await res.json();
				if (!js.ok) {
					alert(js.error || "inspect failed");
					return;
				}

				lastInspect = js;
				const cols = js.columns || [];
				fillSelect($("impSkuCol"), cols, false);
				fillSelect($("impSkuColAlt"), cols, true);
				fillSelect($("impPriceCol"), cols, true);
				fillSelect($("impPriceCol2"), cols, true);
				fillSelect($("impStockCol"), cols, true);

				await loadImpMapPreset();
				let anyPresetApplied = false;
				if (impMapPreset) {
					anyPresetApplied |= selSetByPref($("impSkuCol"), impMapPreset.sku);
					anyPresetApplied |= selSetByPref($("impSkuColAlt"), impMapPreset.sku2);
					anyPresetApplied |= selSetByPref($("impPriceCol"), impMapPreset.p1);
					anyPresetApplied |= selSetByPref($("impPriceCol2"), impMapPreset.p2);
					anyPresetApplied |= selSetByPref($("impStockCol"), impMapPreset.st);

					const s = $("impMapStatus");
					if (s) s.textContent = anyPresetApplied ? "‡πÇ‡∏´‡∏•‡∏î mapping ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "‡∏°‡∏µ mapping ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ";
				}

				function isSet(sel) { return sel && String(sel.value || "0") !== "0"; }
				if (js.suggest) {
					if (!isSet($("impSkuCol")) && js.suggest.sku_col_idx) $("impSkuCol").value = String(js.suggest.sku_col_idx);
					if (!isSet($("impSkuColAlt")) && js.suggest.sku_col_idx_alt) $("impSkuColAlt").value = String(js.suggest.sku_col_idx_alt);
					if (!isSet($("impPriceCol")) && js.suggest.price_col_idx) $("impPriceCol").value = String(js.suggest.price_col_idx);
					if (!isSet($("impPriceCol2")) && js.suggest.price_col_idx2) $("impPriceCol2").value = String(js.suggest.price_col_idx2);
					if (!isSet($("impStockCol")) && js.suggest.stock_col_idx) $("impStockCol").value = String(js.suggest.stock_col_idx);
				}

				$("impMappingArea")?.classList.remove("d-none");
				togglePlatformExtras();
				setProgress(20);
			});

			["impSkuCol", "impSkuColAlt", "impPriceCol", "impPriceCol2", "impStockCol"].forEach(id => {
				$(id)?.addEventListener("change", () => {
					const s = $("impMapStatus");
					if (s) s.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
					scheduleSaveMapping();
				});
			});

			$("btnImpMapClear")?.addEventListener("click", async () => {
				const p = _platKey();
				if (!confirm("‡∏•‡πâ‡∏≤‡∏á Mapping ‡∏Ç‡∏≠‡∏á Platform ‡∏ô‡∏µ‡πâ?")) return;
				await fetch("/api/price/platform_import/mapping/clear", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					credentials: "same-origin",
					body: JSON.stringify({ platform: p })
				});
				const s = $("impMapStatus");
				if (s) s.textContent = "‡∏•‡πâ‡∏≤‡∏á mapping ‡πÅ‡∏•‡πâ‡∏ß";
			});

			function appendStockAdjSettings(fd) {
				// Preset-only (no fallback)
				if (!impPreset) return;
				(impPreset.stock_rules || []).forEach(r => fd.append('stock_rule', String(r)));
				fd.append('stock_divisor', String(impPreset.stock_divisor || 3));
				fd.append('stock_divisor_brand', String(impPreset.stock_divisor_brand || 2));
				fd.append('stock_brands_4', impPreset.stock_brands_4 || '');
				fd.append('stock_brands_5', impPreset.stock_brands_5 || '');
				fd.append('stock_divide_brand_floor12_to0', impPreset.stock_divide_brand_floor12_to0 ? '1' : '0');
				fd.append('stock_divide_brand_min1_when_zero', impPreset.stock_divide_brand_min1_when_zero ? '1' : '0');
			}

			$("btnImpApply")?.addEventListener("click", async () => {
				const file = $("impFile")?.files?.[0];
				if (!file) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå"); return; }
				if (!lastInspect) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô"); return; }
				if (!impPreset) {
					alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Setting ‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Export Price & Stock Adj. ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô");
					return;
				}

				$("btnImpDownload")?.classList.add("disabled");
				if ($("btnImpDownload")) $("btnImpDownload").href = "#";
				if ($("impStats")) $("impStats").textContent = "";
				setProgress(30);

				const fd = new FormData();
				fd.append("file", file);
				fd.append("platform", $("impPlatform")?.value || "");
				const adjPct = Number(impPreset.adj_pct || 0);
				const useSell1 = !!impPreset.use_sell1;
				const skipBC = !!impPreset.skip_adj_when_brand_control;
				const skipProfit = !!impPreset.skip_adj_when_profit_our;
				const profitMin = Number(impPreset.profit_our_min_pct || 10);
				fd.append("adj_pct", String(adjPct || 0));
				fd.append("use_sell1", useSell1 ? "1" : "0");
				fd.append("skip_adj_when_brand_control", skipBC ? "1" : "0");
				fd.append("skip_adj_when_profit_our", skipProfit ? "1" : "0");
				fd.append("profit_our_min_pct", String(profitMin));

				fd.append("sheet_name", lastInspect.sheet_name || "");
				fd.append("header_row", String(lastInspect.header_row || 1));
				fd.append("sku_col_idx", $("impSkuCol")?.value || "0");
				fd.append("sku_col_idx_alt", $("impSkuColAlt")?.value || "0");
				fd.append("price_col_idx", $("impPriceCol")?.value || "0");
				fd.append("price_col_idx2", $("impPriceCol2")?.value || "0");
				fd.append("stock_col_idx", $("impStockCol")?.value || "0");

				// reuse settings from Export Stock Adj modal (if user configured it)
				appendStockAdjSettings(fd);

				setProgress(60);
				const res = await fetch("/api/price/platform_import/apply", {
					method: "POST",
					body: fd,
					credentials: 'same-origin'
				});
				const js = await res.json();
				if (!js.ok) {
					alert(js.error || "apply failed");
					setProgress(0);
					return;
				}

				setProgress(100);
				const st = js.stats || {};
				if ($("impStats")) {
					$("impStats").innerHTML =
						`Matched: <b>${st.matched || 0}</b> / ${st.total_rows || 0} (Coverage ~ ${(st.match_pct || 0).toFixed(1)}%)` +
						`<br>Updated Price: ${st.updated_price || 0}, Updated Stock: ${st.updated_stock || 0}`;
				}

				if ($("btnImpDownload")) {
					$("btnImpDownload").href = js.download_url;
					$("btnImpDownload").classList.remove("disabled");
				}
			});

			// Auto-load preset on modal open and platform change
			$("importPlatformModal")?.addEventListener("shown.bs.modal", () => {
				const p = $("impPlatform")?.value || "";
				loadImpPresetForPlatform(p);
				togglePlatformExtras();
			});
			$("impPlatform")?.addEventListener("change", (e) => {
				loadImpPresetForPlatform(e.target.value || "");
				togglePlatformExtras();
			});
			togglePlatformExtras();
		})();
	</script>

	<script>
		(function () {
			// ===== DATA DEFINITIONS =====
			// ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Column ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢ (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
			const COL_GROUPS = {
				'Product Info': [
					{ key: 'sku', label: 'SKU' },
					{ key: 'brand', label: 'Brand' },
					{ key: 'name', label: 'Name' },
					{ key: 'stock_internal', label: 'Stock Internal' },
					{ key: 'stock', label: 'Stock' },
					{ key: 'monthly_sales', label: 'Monthly Sales' },
				],
				'Price & Market': [
					{ key: 'cost', label: 'Cost' },
					{ key: 'our_price', label: 'Our Price' },
					{ key: 'market_best', label: 'Market (best)' },
					{ key: 'voucher', label: 'Voucher' },
					{ key: 'brand_control', label: 'Brand Control' },
					{ key: 'gap', label: 'Gap' },
				],
				'Calculated': [
					{ key: 'stock_adj', label: 'Stock Adj' },
					{ key: 'profit_our', label: 'Profit@Our' },
					{ key: 'profit_match', label: 'Profit@Match' },
					{ key: 'recommend', label: 'Recommend' },
					{ key: 'adj_note', label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' },
					{ key: 'our_before', label: '‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö' },
					{ key: 'our_after', label: '‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö' },
					{ key: 'adj_pct', label: '‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏µ‡πà%' },
				],
				'Meta Data': [
					{ key: 'shop', label: 'Shop' },
					{ key: 'mall', label: 'MALL' },
					{ key: 'url', label: 'URL' },
					{ key: 'owner', label: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' },
					{ key: 'updated', label: 'Updated' },
				],
			};

			function renderModernCols() {
				const container = document.getElementById('adjColsContainer');
				if (!container) return;
				container.innerHTML = '';

				for (const [groupName, items] of Object.entries(COL_GROUPS)) {
					const groupDiv = document.createElement('div');
					groupDiv.className = 'col-md-6';

					let html = `<div class="col-picker-group">`;
					html += `<div class="col-picker-title">${groupName}</div>`;

					items.forEach(c => {
						const id = 'adj_' + c.key;
						html += `
						<label class="col-check-item" for="${id}">
							<input class="form-check-input mt-0" type="checkbox" name="cols" value="${c.key}" id="${id}" checked>
							<span>${c.label}</span>
						</label>`;
					});
					html += `</div>`;
					groupDiv.innerHTML = html;
					container.appendChild(groupDiv);
				}
			}

			// ===== UI LOGIC HANDLERS =====
			function updateCardVisuals() {
				// 1) Rule 1 (Independent)
				const r1 = document.getElementById('stockRule1');
				const card1 = document.getElementById('cardRule1');
				if (r1 && card1) {
					card1.classList.toggle('active', !!r1.checked);
				}

				// 2) Rule 2 (Independent)
				const r2 = document.getElementById('stockRule2');
				const card2 = document.getElementById('cardRule2');
				if (r2 && card2) {
					card2.classList.toggle('active', !!r2.checked);
				}

				// 3) Rule 3
				const r3 = document.getElementById('stockRule3');
				const card3 = document.getElementById('cardRule3');
				const wrap3 = document.getElementById('wrapRule3');
				if (r3 && card3 && wrap3) {
					card3.classList.toggle('active', !!r3.checked);
					wrap3.classList.toggle('d-none', !r3.checked);
				}

				// 4) Rule 4 (Brand Override -> Stock = 0)
				const r4 = document.getElementById('stockRule4');
				const card4 = document.getElementById('cardRule4');
				const wrap4 = document.getElementById('wrapRule4');
				if (r4 && card4 && wrap4) {
					card4.classList.toggle('active', !!r4.checked);
					wrap4.classList.toggle('d-none', !r4.checked);
				}

				// 5) Rule 5 (Brand Override -> Divide)
				const r5 = document.getElementById('stockRule5');
				const card5 = document.getElementById('cardRule5');
				const wrap5 = document.getElementById('wrapRule5');
				if (r5 && card5 && wrap5) {
					card5.classList.toggle('active', !!r5.checked);
					wrap5.classList.toggle('d-none', !r5.checked);
				}

				// Auto-check Stock Adj column when any rule is active
				const anyRule = document.querySelectorAll('.pm-stock-rule:checked').length > 0;
				if (anyRule) {
					const cbAdj = document.getElementById('adj_stock_adj');
					if (cbAdj) cbAdj.checked = true;
				}
			}

			function enforceConstraints(triggerSource) {
				const r1 = document.getElementById('stockRule1');
				const r2 = document.getElementById('stockRule2');
				const r3 = document.getElementById('stockRule3');

				// Rule 3 (Divide) ‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ö Rule 1 ‡πÅ‡∏•‡∏∞ 2
				// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏´‡∏£‡∏∑‡∏≠ 2 -> ‡∏õ‡∏•‡∏î 3
				if ((triggerSource === '1' || triggerSource === '2') && ((r1 && r1.checked) || (r2 && r2.checked))) {
					if (r3) r3.checked = false;
				}
				// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 -> ‡∏õ‡∏•‡∏î 1 ‡πÅ‡∏•‡∏∞ 2
				if (triggerSource === '3' && r3 && r3.checked) {
					if (r1) r1.checked = false;
					if (r2) r2.checked = false;
				}

				updateCardVisuals();
			}

			function initEvents() {
				// Rule 1
				document.getElementById('stockRule1')?.addEventListener('change', () => enforceConstraints('1'));
				document.getElementById('cardRule1')?.addEventListener('click', (e) => {
					if (e.target.tagName !== 'INPUT') document.getElementById('stockRule1')?.click();
				});

				// Rule 2
				document.getElementById('stockRule2')?.addEventListener('change', () => enforceConstraints('2'));
				document.getElementById('cardRule2')?.addEventListener('click', (e) => {
					if (e.target.tagName !== 'INPUT') document.getElementById('stockRule2')?.click();
				});

				// Rule 3
				document.getElementById('stockRule3')?.addEventListener('change', () => enforceConstraints('3'));
				document.getElementById('cardRule3')?.addEventListener('click', (e) => {
					if (e.target.closest('.logic-card-inputs')) return;
					if (e.target.tagName !== 'INPUT') document.getElementById('stockRule3')?.click();
				});

				// Rule 4
				document.getElementById('stockRule4')?.addEventListener('change', updateCardVisuals);
				document.getElementById('cardRule4')?.addEventListener('click', (e) => {
					if (e.target.closest('.logic-card-inputs')) return;
					if (e.target.tagName !== 'INPUT') document.getElementById('stockRule4')?.click();
				});

				// Rule 5
				document.getElementById('stockRule5')?.addEventListener('change', updateCardVisuals);
				document.getElementById('cardRule5')?.addEventListener('click', (e) => {
					if (e.target.closest('.logic-card-inputs')) return;
					if (e.target.tagName !== 'INPUT') document.getElementById('stockRule5')?.click();
				});

				// Other Platform Toggle
				const selPlat = document.getElementById('adjPlatformSelect');
				const inpPlat = document.getElementById('adjPlatformOtherInput');
				if (selPlat && inpPlat) {
					selPlat.addEventListener('change', () => {
						inpPlat.classList.toggle('d-none', selPlat.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
						try { loadPreset(); } catch (e) { }
					});
					inpPlat.addEventListener('change', () => {
						try { loadPreset(); } catch (e) { }
					});
				}

				// Select All/None Columns
				document.getElementById('adjColsAll')?.addEventListener('click', () => {
					document.querySelectorAll('#adjColsContainer input[type="checkbox"]').forEach(cb => cb.checked = true);
				});
				document.getElementById('adjColsNone')?.addEventListener('click', () => {
					document.querySelectorAll('#adjColsContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
				});

				// Preview Calculation (AJAX)
				document.getElementById('btnStockAdjConfirm')?.addEventListener('click', async () => {
					const modal = document.getElementById('exportStockAdjModal');
					const form = modal?.querySelector('form');
					const btn = document.getElementById('btnStockAdjConfirm');
					const elCount = document.getElementById('stockAdjCount');
					const elTotal = document.getElementById('stockAdjTotal');
					const badge = document.getElementById('stockAdjCountBadge');
					if (!form || !btn) return;

					try {
						btn.disabled = true;
						btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...';
						if (badge) badge.textContent = 'Calculating...';

						const params = new URLSearchParams(new FormData(form));
						params.set('preview', '1');
						const res = await fetch(form.action + '?' + params.toString(), {
							method: 'GET',
							headers: { 'Accept': 'application/json' },
							credentials: 'same-origin'
						});
						if (!res.ok) throw new Error('preview failed');
						const data = await res.json();

						if (elTotal) elTotal.textContent = String(data.total || 0);
						if (elCount) elCount.textContent = String(data.adjusted || 0);
						if (badge) badge.textContent = String(data.adjusted || 0) + ' SKU';

						const anyRule = document.querySelectorAll('.pm-stock-rule:checked').length > 0;
						if (anyRule) {
							const cbAdj = document.getElementById('adj_stock_adj');
							if (cbAdj) cbAdj.checked = true;
						}
					} catch (e) {
						alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
						if (badge) badge.textContent = 'Error';
					} finally {
						btn.disabled = false;
						btn.innerHTML = '<i class="bi bi-calculator me-1"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Preview)';
					}
				});
			}

			// ===== Preset helpers =====
			let presetBaseline = null;
			let presetBaselinePlatform = '';

			function flash(el) {
				if (!el) return;
				el.classList.remove('preset-flash');
				void el.offsetWidth; // restart animation
				el.classList.add('preset-flash');
			}

			function resetPreviewUI() {
				const elCount = document.getElementById('stockAdjCount');
				const elTotal = document.getElementById('stockAdjTotal');
				const badge = document.getElementById('stockAdjCountBadge');
				if (elCount) elCount.textContent = '0';
				if (elTotal) elTotal.textContent = '0';
				if (badge) badge.textContent = 'Ready';
			}
			function resolveDestPlatform() {
				const modal = document.getElementById('exportStockAdjModal');
				const dashPlat = modal?.dataset?.dashboardPlatform || '';
				const sel = document.getElementById('adjPlatformSelect');
				const other = document.getElementById('adjPlatformOtherInput');

				let v = (sel?.value || '').trim();
				if (v === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') v = (other?.value || '').trim();
				if (!v) v = dashPlat || '';
				return v;
			}

			function getSelectedCols() {
				return Array.from(document.querySelectorAll('#adjColsContainer input[name="cols"]:checked'))
					.map(cb => cb.value);
			}

			function setSelectedCols(cols) {
				const set = new Set(cols || []);
				document.querySelectorAll('#adjColsContainer input[name="cols"]').forEach(cb => {
					cb.checked = set.has(cb.value);
				});
			}

			function getSelectedRules() {
				return Array.from(document.querySelectorAll('.pm-stock-rule:checked')).map(cb => cb.value);
			}

			function setSelectedRules(rules) {
				const set = new Set(rules || []);
				document.querySelectorAll('.pm-stock-rule').forEach(cb => {
					cb.checked = set.has(cb.value);
				});
				try { enforceConstraints('init'); } catch (e) { }
				try { updateCardVisuals(); } catch (e) { }
			}

			function collectPreset() {
				return {
					adj_pct: Number(document.querySelector('input[name="adj_pct"]')?.value || 0),
					cols: getSelectedCols(),
					stock_rules: getSelectedRules(),
					stock_divisor: Number(document.querySelector('input[name="stock_divisor"]')?.value || 3),
					stock_brands_4: (document.querySelector('input[name="stock_brands_4"]')?.value || ''),
					stock_brands_5: (document.querySelector('input[name="stock_brands_5"]')?.value || ''),
					stock_divisor_brand: Number(document.querySelector('input[name="stock_divisor_brand"]')?.value || 2),
					stock_divide_brand_floor12_to0: !!document.getElementById('stockDivideBrandFloor12')?.checked,
					stock_divide_brand_min1_when_zero: !!document.getElementById('stockDivideBrandMin1')?.checked,
					use_sell1: !!document.getElementById('useSell1Base')?.checked,
					skip_adj_when_brand_control: !!document.getElementById('skipAdjWhenBrandControl')?.checked,
					skip_adj_when_profit_our: !!document.getElementById('skipAdjWhenProfitOur')?.checked,
					profit_our_min_pct: Number(document.getElementById('profitOurMinPct')?.value || 0),
				};
			}

			function applyPreset(p) {
				if (!p) return;

				const ip = document.querySelector('input[name="adj_pct"]');
				if (ip && (p.adj_pct !== undefined && p.adj_pct !== null)) ip.value = p.adj_pct;

				setSelectedRules(p.stock_rules || []);
				const d3 = document.querySelector('input[name="stock_divisor"]');
				if (d3 && p.stock_divisor) d3.value = p.stock_divisor;
				const b4 = document.querySelector('input[name="stock_brands_4"]');
				if (b4 && p.stock_brands_4 !== undefined) b4.value = p.stock_brands_4;
				const b5 = document.querySelector('input[name="stock_brands_5"]');
				if (b5 && p.stock_brands_5 !== undefined) b5.value = p.stock_brands_5;
				const d5 = document.querySelector('input[name="stock_divisor_brand"]');
				if (d5 && p.stock_divisor_brand) d5.value = p.stock_divisor_brand;
				const cbF = document.getElementById('stockDivideBrandFloor12');
				if (cbF) cbF.checked = (p.stock_divide_brand_floor12_to0 !== false);
				const cbM = document.getElementById('stockDivideBrandMin1');
				if (cbM) cbM.checked = (p.stock_divide_brand_min1_when_zero === true);

				const cbSell1 = document.getElementById('useSell1Base');
				if (cbSell1) cbSell1.checked = (p.use_sell1 === true);

				const cbSkip = document.getElementById('skipAdjWhenBrandControl');
				if (cbSkip) cbSkip.checked = (p.skip_adj_when_brand_control === true);

				const cbP = document.getElementById('skipAdjWhenProfitOur');
				if (cbP) cbP.checked = (p.skip_adj_when_profit_our === true);

				const ipP = document.getElementById('profitOurMinPct');
				if (ipP && p.profit_our_min_pct !== undefined) ipP.value = String(p.profit_our_min_pct);

				if (Array.isArray(p.cols)) {
					setSelectedCols(p.cols); // apply even when []
				}
				['adj_note', 'our_before', 'our_after', 'adj_pct'].forEach(k => {
					const cb = document.getElementById('adj_' + k);
					if (cb) cb.checked = true;
				});

				if ((p.stock_rules || []).length) {
					const cbAdj = document.getElementById('adj_stock_adj');
					if (cbAdj) cbAdj.checked = true;
				}
			}

			async function loadPreset() {
				const dest = resolveDestPlatform();
				const status = document.getElementById('presetStatus');
				if (status) status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Setting...';
				try {
					const res = await fetch(`/api/price/export_preset?dest_platform=${encodeURIComponent(dest)}`, {
						headers: { 'Accept': 'application/json' },
						credentials: 'same-origin'
					});
					const data = await res.json();
					resetPreviewUI();
					if (data && data.success && data.preset) {
						applyPreset(data.preset);
						presetBaseline = collectPreset();
						presetBaselinePlatform = dest;
						if (status) status.textContent = `‡πÉ‡∏ä‡πâ Setting ‡∏Ç‡∏≠‡∏á "${dest}" ‡∏≠‡∏¢‡∏π‡πà`;

						flash(document.querySelector('#exportStockAdjModal .card.bg-light.border-0'));
						flash(document.querySelector('#exportStockAdjModal .flex-grow-1'));
						flash(document.querySelector('#exportStockAdjModal #adjColsContainer')?.closest('.border'));
					} else {
						presetBaseline = null;
						presetBaselinePlatform = '';
						if (status) status.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Setting ‡∏Ç‡∏≠‡∏á "${dest}"`;
					}
				} catch (e) {
					presetBaseline = null;
					presetBaselinePlatform = '';
					if (status) status.textContent = '‡πÇ‡∏´‡∏•‡∏î Setting ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
				}
			}

			async function savePreset() {
				const dest = resolveDestPlatform();
				const preset = collectPreset();
				const status = document.getElementById('presetStatus');
				if (status) status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
				try {
					const res = await fetch('/api/price/export_preset/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ dest_platform: dest, preset })
					});
					const data = await res.json();
					if (data && data.success) {
						presetBaseline = collectPreset();
						presetBaselinePlatform = dest;
					}
					if (status) status.textContent = (data && data.success) ? `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Setting ‡∏Ç‡∏≠‡∏á "${dest}" ‡πÅ‡∏•‡πâ‡∏ß` : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
				} catch (e) {
					if (status) status.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
				}
			}

			async function clearPreset() {
				const dest = resolveDestPlatform();
				const status = document.getElementById('presetStatus');
				if (status) status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á...';
				try {
					const res = await fetch('/api/price/export_preset/clear', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ dest_platform: dest })
					});
					const data = await res.json();
					if (status) status.textContent = data.success ? `‡∏•‡πâ‡∏≤‡∏á Setting ‡∏Ç‡∏≠‡∏á "${dest}" ‡πÅ‡∏•‡πâ‡∏ß` : '‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
				} catch (e) {
					if (status) status.textContent = '‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
				}

				presetBaseline = null;
				presetBaselinePlatform = '';

				const ip = document.querySelector('input[name="adj_pct"]');
				if (ip) ip.value = 0;
				document.querySelectorAll('.pm-stock-rule').forEach(cb => cb.checked = false);
				const b4 = document.querySelector('input[name="stock_brands_4"]');
				if (b4) b4.value = '';
				const b5 = document.querySelector('input[name="stock_brands_5"]');
				if (b5) b5.value = '';
				const d3 = document.querySelector('input[name="stock_divisor"]');
				if (d3) d3.value = 3;
				const d5 = document.querySelector('input[name="stock_divisor_brand"]');
				if (d5) d5.value = 2;
				const cbF = document.getElementById('stockDivideBrandFloor12');
				if (cbF) cbF.checked = true;
				const cbM = document.getElementById('stockDivideBrandMin1');
				if (cbM) cbM.checked = false;
				const cbSell1 = document.getElementById('useSell1Base');
				if (cbSell1) cbSell1.checked = false;
				const cbSkip = document.getElementById('skipAdjWhenBrandControl');
				if (cbSkip) cbSkip.checked = false;
				const cbP = document.getElementById('skipAdjWhenProfitOur');
				if (cbP) cbP.checked = false;
				const ipP = document.getElementById('profitOurMinPct');
				if (ipP) ipP.value = 10;
				document.querySelectorAll('#adjColsContainer input[name="cols"]').forEach(cb => cb.checked = true);
				['adj_note', 'our_before', 'our_after', 'adj_pct'].forEach(k => {
					const cb = document.getElementById('adj_' + k);
					if (cb) cb.checked = true;
				});
				resetPreviewUI();
				try { updateCardVisuals(); } catch (e) { }
			}

			document.getElementById('btnPresetSave')?.addEventListener('click', savePreset);
			document.getElementById('btnPresetClear')?.addEventListener('click', clearPreset);

			// Dirty state: show status when user edits after preset loaded
			const modalForm = document.querySelector('#exportStockAdjModal form');
			modalForm?.addEventListener('change', () => {
				if (!presetBaseline) return;
				const now = collectPreset();
				const changed = JSON.stringify(now) !== JSON.stringify(presetBaseline);
				const status = document.getElementById('presetStatus');
				if (!status) return;
				status.textContent = changed
					? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å Setting ‡∏Ç‡∏≠‡∏á "${presetBaselinePlatform}" ‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)`
					: `‡πÉ‡∏ä‡πâ Setting ‡∏Ç‡∏≠‡∏á "${presetBaselinePlatform}" ‡∏≠‡∏¢‡∏π‡πà`;
			});

			// Run on Modal Show
			const modal = document.getElementById('exportStockAdjModal');
			if (modal && modal.addEventListener) {
				modal.addEventListener('show.bs.modal', () => {
					renderModernCols();
					updateCardVisuals();
					const selPlat = document.getElementById('adjPlatformSelect');
					const inpPlat = document.getElementById('adjPlatformOtherInput');
					if (selPlat && inpPlat) inpPlat.classList.toggle('d-none', selPlat.value !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
					try { loadPreset(); } catch (e) { }
				});
			}

			initEvents();
		})();
	</script>

	<script>
		(function () {
			const modalEl = document.getElementById('autoPriceModal');
			const rulesInput = document.getElementById('pmAutoRules');
			const matchedEl = document.getElementById('pmAutoMatched');
			const totalEl = document.getElementById('pmAutoTotal');
			const r9PreviewEl = document.getElementById('pmAutoR9Preview');
			const btnConfirm = document.getElementById('pmAutoConfirm');
			const btnAll = document.getElementById('pmAutoAll');
			const btnClear = document.getElementById('pmAutoClear');
			const cfgHidden = document.getElementById('pmR9Cfg');
			const r10CfgHidden = document.getElementById('pmR10Cfg');
			const r11CfgHidden = document.getElementById('pmR11Cfg');
			const descEl = document.getElementById('pmR9Desc');
			const saveStatus = document.getElementById('pmR9SaveStatus');
			const resetBtn = document.getElementById('pmR9ResetBtn');

			const r10MinLossEl = document.getElementById('pmR10MinLoss');
			const r10SaveStatus = document.getElementById('pmR10SaveStatus');
			const r11MinLossEl = document.getElementById('pmR11MinLoss');
			const r11MaxLossEl = document.getElementById('pmR11MaxLoss');
			const r11SaveStatus = document.getElementById('pmR11SaveStatus');

			if (!modalEl || !rulesInput || !matchedEl || !totalEl || !btnConfirm) return;

			const DEFAULT_R9_CFG = [
				{ min: 5, max: 10, pct: 200.0 },
				{ min: 11, max: 20, pct: 150.0 },
				{ min: 21, max: 49, pct: 120.0 },
				{ min: 50, max: 99, pct: 80.0 },
				{ min: 100, max: 499, pct: 50.0 },
				{ min: 500, max: 699, pct: 45.0 },
				{ min: 700, max: 999, pct: 40.0 },
				{ min: 1000, max: null, pct: 35.0 },
			];

			function readCfgFromInputs() {
				const arr = [];
				document.querySelectorAll('.pm-r9-pct').forEach(inp => {
					const lo = Number(inp.dataset.min);
					const hiRaw = (inp.dataset.max || '').trim();
					const hi = hiRaw ? Number(hiRaw) : null;
					let pct = Number(inp.value);
					if (!Number.isFinite(pct)) pct = 0;
					pct = Math.max(0, Math.min(500, pct));
					arr.push({ min: lo, max: (Number.isFinite(hi) ? hi : null), pct });
				});
				arr.sort((a, b) => a.min - b.min);
				if (cfgHidden) cfgHidden.value = JSON.stringify(arr);
				return arr;
			}

			function renderR9Desc(cfg) {
				if (!descEl) return;
				const parts = (cfg || []).map(x => {
					const hi = (x.max === null || x.max === undefined) ? null : x.max;
					const range = hi ? `${x.min}‚Äì${hi}` : `‚â•${x.min}`;
					const pct = Number(x.pct);
					const pctTxt = Number.isFinite(pct) ? pct.toFixed(1).replace(/\.0$/, '') : '0';
					return `${range} +${pctTxt}%`;
				});
				descEl.textContent = 'Market(best) ‡∏ß‡πà‡∏≤‡∏á/0 ‡πÅ‡∏•‡∏∞ Cost: ' + parts.join(' | ');
			}

			function applyCfgToInputs(cfg) {
				const map = new Map();
				(cfg || []).forEach(x => {
					const k = `${x.min}|${(x.max === null || x.max === undefined) ? '' : x.max}`;
					map.set(k, x);
				});
				document.querySelectorAll('.pm-r9-pct').forEach(inp => {
					const k = `${Number(inp.dataset.min)}|${(inp.dataset.max || '').trim()}`;
					if (map.has(k)) inp.value = String(map.get(k).pct);
				});
				const now = readCfgFromInputs();
				renderR9Desc(now);
			}

			const R9_LS_KEY = 'pm_auto_r9_cfg_v1';
			let r9SaveTimer = null;
			const R10_LS_KEY = 'pm_auto_r10_cfg_v1';
			const R11_LS_KEY = 'pm_auto_r11_cfg_v1';
			let r10SaveTimer = null;
			let r11SaveTimer = null;

			async function saveR9Cfg(cfg) {
				if (saveStatus) saveStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
				try {
					const res = await fetch('/api/price/auto_r9/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ cfg })
					});
					const js = await res.json();
					if (js && js.success) {
						localStorage.setItem(R9_LS_KEY, JSON.stringify(cfg));
						if (saveStatus) saveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
					} else {
						if (saveStatus) saveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
					}
				} catch (e) {
					try { localStorage.setItem(R9_LS_KEY, JSON.stringify(cfg)); } catch (e2) { }
					if (saveStatus) saveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
				}
			}

			function scheduleR9Save() {
				clearTimeout(r9SaveTimer);
				const cfg = readCfgFromInputs();
				renderR9Desc(cfg);
				if (saveStatus) saveStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
				r9SaveTimer = setTimeout(() => saveR9Cfg(cfg), 400);
				try { refreshAutoPreview(); } catch (e) { }
			}

			function writeHiddenCfg(hiddenEl, cfgObj) {
				if (!hiddenEl) return;
				try {
					hiddenEl.value = JSON.stringify(cfgObj || {});
				} catch (e) {
					hiddenEl.value = '';
				}
			}

			function readR10CfgFromInputs() {
				let minLoss = Number(r10MinLossEl ? r10MinLossEl.value : 5);
				if (!Number.isFinite(minLoss)) minLoss = 5;
				minLoss = Math.max(0, Math.min(50, minLoss));
				const cfg = { min_loss_pct: minLoss };
				writeHiddenCfg(r10CfgHidden, cfg);
				return cfg;
			}

			function readR11CfgFromInputs() {
				let minLoss = Number(r11MinLossEl ? r11MinLossEl.value : 5);
				let maxLoss = Number(r11MaxLossEl ? r11MaxLossEl.value : 20);
				if (!Number.isFinite(minLoss)) minLoss = 5;
				if (!Number.isFinite(maxLoss)) maxLoss = 20;
				minLoss = Math.max(0, Math.min(50, minLoss));
				maxLoss = Math.max(0, Math.min(80, maxLoss));
				if (maxLoss < minLoss) {
					const tmp = maxLoss;
					maxLoss = minLoss;
					minLoss = tmp;
				}
				const cfg = { min_loss_pct: minLoss, max_loss_pct: maxLoss };
				writeHiddenCfg(r11CfgHidden, cfg);
				return cfg;
			}

			async function saveR10Cfg(cfg) {
				if (r10SaveStatus) r10SaveStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
				try {
					const res = await fetch('/api/price/auto_r10/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ cfg })
					});
					const js = await res.json();
					if (js && js.success) {
						localStorage.setItem(R10_LS_KEY, JSON.stringify(cfg));
						if (r10SaveStatus) r10SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
					} else {
						if (r10SaveStatus) r10SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
					}
				} catch (e) {
					try { localStorage.setItem(R10_LS_KEY, JSON.stringify(cfg)); } catch (e2) { }
					if (r10SaveStatus) r10SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
				}
			}

			async function saveR11Cfg(cfg) {
				if (r11SaveStatus) r11SaveStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
				try {
					const res = await fetch('/api/price/auto_r11/save', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify({ cfg })
					});
					const js = await res.json();
					if (js && js.success) {
						localStorage.setItem(R11_LS_KEY, JSON.stringify(cfg));
						if (r11SaveStatus) r11SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
					} else {
						if (r11SaveStatus) r11SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
					}
				} catch (e) {
					try { localStorage.setItem(R11_LS_KEY, JSON.stringify(cfg)); } catch (e2) { }
					if (r11SaveStatus) r11SaveStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
				}
			}

			function scheduleR10Save() {
				clearTimeout(r10SaveTimer);
				const cfg = readR10CfgFromInputs();
				if (r10SaveStatus) r10SaveStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
				r10SaveTimer = setTimeout(() => saveR10Cfg(cfg), 400);
				try { refreshAutoPreview(); } catch (e) { }
			}

			function scheduleR11Save() {
				clearTimeout(r11SaveTimer);
				const cfg = readR11CfgFromInputs();
				if (r11SaveStatus) r11SaveStatus.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
				r11SaveTimer = setTimeout(() => saveR11Cfg(cfg), 400);
				try { refreshAutoPreview(); } catch (e) { }
			}

			document.addEventListener('input', (e) => {
				if (e.target && e.target.id === 'pmR10MinLoss') scheduleR10Save();
				if (e.target && (e.target.id === 'pmR11MinLoss' || e.target.id === 'pmR11MaxLoss')) scheduleR11Save();
			});

			async function loadR10CfgOnShow() {
				// 1) server
				try {
					const res = await fetch('/api/price/auto_r10', { credentials: 'same-origin' });
					const js = await res.json();
					if (js && js.success && js.cfg && typeof js.cfg === 'object') {
						if (r10MinLossEl && js.cfg.min_loss_pct !== undefined) r10MinLossEl.value = String(js.cfg.min_loss_pct);
						readR10CfgFromInputs();
						if (r10SaveStatus) r10SaveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 2) localStorage
				try {
					const raw = localStorage.getItem(R10_LS_KEY);
					if (raw) {
						const cfg = JSON.parse(raw);
						if (r10MinLossEl && cfg && cfg.min_loss_pct !== undefined) r10MinLossEl.value = String(cfg.min_loss_pct);
						readR10CfgFromInputs();
						if (r10SaveStatus) r10SaveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 3) default
				readR10CfgFromInputs();
			}

			async function loadR11CfgOnShow() {
				// 1) server
				try {
					const res = await fetch('/api/price/auto_r11', { credentials: 'same-origin' });
					const js = await res.json();
					if (js && js.success && js.cfg && typeof js.cfg === 'object') {
						if (r11MinLossEl && js.cfg.min_loss_pct !== undefined) r11MinLossEl.value = String(js.cfg.min_loss_pct);
						if (r11MaxLossEl && js.cfg.max_loss_pct !== undefined) r11MaxLossEl.value = String(js.cfg.max_loss_pct);
						readR11CfgFromInputs();
						if (r11SaveStatus) r11SaveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 2) localStorage
				try {
					const raw = localStorage.getItem(R11_LS_KEY);
					if (raw) {
						const cfg = JSON.parse(raw);
						if (r11MinLossEl && cfg && cfg.min_loss_pct !== undefined) r11MinLossEl.value = String(cfg.min_loss_pct);
						if (r11MaxLossEl && cfg && cfg.max_loss_pct !== undefined) r11MaxLossEl.value = String(cfg.max_loss_pct);
						readR11CfgFromInputs();
						if (r11SaveStatus) r11SaveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 3) default
				readR11CfgFromInputs();
			}

			document.addEventListener('input', (e) => {
				if (e.target && e.target.classList && e.target.classList.contains('pm-r9-pct')) {
					scheduleR9Save();
				}
			});

			resetBtn?.addEventListener('click', () => {
				applyCfgToInputs(DEFAULT_R9_CFG);
				saveR9Cfg(DEFAULT_R9_CFG);
				try { refreshAutoPreview(); } catch (e) { }
			});

			async function loadR9CfgOnShow() {
				// 1) server
				try {
					const res = await fetch('/api/price/auto_r9', { credentials: 'same-origin' });
					const js = await res.json();
					if (js && js.success && Array.isArray(js.cfg)) {
						applyCfgToInputs(js.cfg);
						if (saveStatus) saveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 2) localStorage
				try {
					const raw = localStorage.getItem(R9_LS_KEY);
					if (raw) {
						applyCfgToInputs(JSON.parse(raw));
						if (saveStatus) saveStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
						return;
					}
				} catch (e) { }

				// 3) default
				applyCfgToInputs(DEFAULT_R9_CFG);
			}

			// expose helper for other JS
			window.pmGetR9Cfg = readCfgFromInputs;

			function getSelectedRules() {
				const checked = Array.from(document.querySelectorAll('.pm-auto-rule:checked'));
				return checked.map(el => el.value).filter(Boolean);
			}

			function rowMatchesSelectedRules(rowRules, selectedRules) {
				if (!rowRules.length || !selectedRules.length) return false;
				const set = new Set(rowRules);
				return selectedRules.some(r => set.has(r));
			}

			function intFromCellText(tr, col) {
				const td = tr.querySelector('td[data-col="' + col + '"]');
				const txt = td ? (td.textContent || '').toString().trim().replace(/,/g, '') : '';
				if (!txt) return 0;
				const n = parseInt(txt, 10);
				return Number.isFinite(n) ? n : 0;
			}

			function boolFromRowAttr(tr, attrName) {
				const raw = (tr.getAttribute(attrName) || '').toString().trim();
				return raw === '1' || raw.toLowerCase() === 'true';
			}

			function agingBucketFromRow(tr) {
				return (tr.getAttribute('data-aging-bucket') || '').toString().trim();
			}

			function roundTo10Thai(n) {
				if (n === null || n === undefined) return null;
				const x = Math.trunc(Number(n));
				if (!Number.isFinite(x)) return null;
				let base = Math.floor(x / 10) * 10;
				if ((x % 10) >= 5) base += 10;
				return base;
			}

			function autoPriceFromCost(cost, cfg) {
				const c = Number(cost);
				if (!Number.isFinite(c)) return null;
				if (c < 5) return null;

				const tiers = Array.isArray(cfg) ? cfg : (window.pmGetR9Cfg ? window.pmGetR9Cfg() : []);
				let pct = null;
				for (const t of tiers) {
					const lo = Number(t.min);
					const hi = (t.max === null || t.max === undefined || t.max === '') ? null : Number(t.max);
					if (!Number.isFinite(lo)) continue;
					if (c < lo) continue;
					if (hi === null || (Number.isFinite(hi) && c <= hi)) {
						pct = Number(t.pct);
						break;
					}
				}
				if (pct === null || !Number.isFinite(pct)) return null;

				const raw = c * (1.0 + (pct / 100.0));
				return roundTo10Thai(raw);
			}

			function roundUpTo5(n) {
				if (n === null || n === undefined) return null;
				const x = Number(n);
				if (!Number.isFinite(x)) return null;
				return Math.ceil(x / 5) * 5;
			}

			function autoPriceFromCostPlusPct(cost, pct) {
				const c = Number(cost);
				if (!Number.isFinite(c)) return null;
				if (c <= 0) return null;
				const raw = c * (1.0 + Number(pct || 0));
				return roundUpTo5(raw);
			}

			function numFromCell(tr, col, attrName) {
				const td = tr.querySelector('td[data-col="' + col + '"]');
				const attr = (attrName || 'data-raw');
				const raw = td ? (td.getAttribute(attr) || td.getAttribute('data-raw') || '').trim() : '';
				if (!raw) return null;
				const n = Number(raw);
				return Number.isFinite(n) ? n : null;
			}

			function lossAbsPctFromRow(tr) {
				const pm = numFromCell(tr, 'profit_match', 'data-raw-pct');
				if (pm === null || pm === undefined) return null;
				const x = Number(pm);
				return Number.isFinite(x) ? Math.abs(x) : null;
			}

			function isClosePrice(a, b, tol) {
				if (a === null || a === undefined || b === null || b === undefined) return false;
				const aa = Number(a);
				const bb = Number(b);
				if (!Number.isFinite(aa) || !Number.isFinite(bb)) return false;
				const t = Number(tol);
				return Math.abs(aa - bb) <= (Number.isFinite(t) ? t : 0.01);
			}

			function refreshAutoPreview() {
				const selected = getSelectedRules();
				rulesInput.value = selected.join(',');

				const r9cfg = readCfgFromInputs();
				renderR9Desc(r9cfg);
				const r10cfg = readR10CfgFromInputs();
				const r11cfg = readR11CfgFromInputs();

				const rows = Array.from(document.querySelectorAll('table.pm-table tbody tr[data-auto-rules]'));
				let matched = 0;
				let willChange = 0;
				const seenMatched = new Set();
				const seenChange = new Set();

				rows.forEach(tr => {
					const sku = tr.getAttribute('data-sku') || '';
					const raw = tr.getAttribute('data-auto-rules') || '';
					const rowRules = raw.split(',').map(s => s.trim()).filter(Boolean);

					// Dynamic recompute for r10/r11 (thresholds can change in-modal)
					const cost = numFromCell(tr, 'cost');
					const ourPrice = numFromCell(tr, 'our_price');
					const marketBest = numFromCell(tr, 'market_best');
					const lossAbs = lossAbsPctFromRow(tr);
					const stockInternal = intFromCellText(tr, 'stock_internal');
					const stockQty = intFromCellText(tr, 'stock');
					const stockOk = (stockInternal > 0) || (stockQty > 0);
					const noSales = boolFromRowAttr(tr, 'data-no-sales');
					const agingBucket = agingBucketFromRow(tr);
					const notAging = (!agingBucket) && (!noSales);
					const base = (marketBest !== null && marketBest > 0) && (ourPrice !== null && ourPrice > 0) && (marketBest < ourPrice);
					const costPos = (cost !== null && cost > 0);

					const r10Min = Number(r10cfg && r10cfg.min_loss_pct);
					const r10MinLoss = Number.isFinite(r10Min) ? r10Min : 5;
					const hasR10Now = base && notAging && costPos && stockOk && (lossAbs !== null && lossAbs > r10MinLoss);

					const r11Min = Number(r11cfg && r11cfg.min_loss_pct);
					const r11MinLoss = Number.isFinite(r11Min) ? r11Min : 5;
					const hasR11Now = base && notAging && costPos && stockOk && (lossAbs !== null && lossAbs > r11MinLoss);

					const match = selected.some(r => {
						if (r === 'r10') return hasR10Now;
						if (r === 'r11') return hasR11Now;
						return rowRules.includes(r);
					});

					tr.classList.toggle('pm-row-auto-selected', match);
					if (!match || !sku) return;

					if (!seenMatched.has(sku)) {
						seenMatched.add(sku);
						matched += 1;
					}

					// Compute target price with backend-like priority: r11 > r9 > r10 > r8 > market_best
					const brandControl = numFromCell(tr, 'brand_control');

					let target = null;
					if (selected.includes('r11') && hasR11Now) {
						const minL = Number(r11cfg && r11cfg.min_loss_pct);
						const maxL = Number(r11cfg && r11cfg.max_loss_pct);
						const minLoss = Number.isFinite(minL) ? minL : 5;
						const maxLoss = Number.isFinite(maxL) ? maxL : 20;
						if (lossAbs !== null && marketBest !== null && marketBest > 0 && lossAbs <= maxLoss) {
							target = marketBest;
						} else if (lossAbs !== null) {
							target = autoPriceFromCostPlusPct(cost, lossAbs / 100.0);
						}
					} else if (selected.includes('r9') && rowRules.includes('r9')) {
						target = autoPriceFromCost(cost, r9cfg);
					} else if (selected.includes('r10') && hasR10Now) {
						if (lossAbs !== null) {
							target = autoPriceFromCostPlusPct(cost, lossAbs / 100.0);
						}
					} else if (selected.includes('r8') && rowRules.includes('r8')) {
						target = brandControl;
					} else {
						target = marketBest;
					}

					const newPrice = (target === null || target === undefined) ? null : Number(target);
					const validNew = (newPrice !== null && Number.isFinite(newPrice) && newPrice > 0);
					if (!validNew) return;

					const same = (ourPrice !== null && isClosePrice(ourPrice, newPrice, 0.01));
					const canChange = !same;
					if (canChange && !seenChange.has(sku)) {
						seenChange.add(sku);
						willChange += 1;
					}
				});

				matchedEl.textContent = String(matched);
				totalEl.textContent = String(willChange);
				btnConfirm.disabled = (selected.length === 0);

				// ---- Rule 9 preview (examples) ----
				if (r9PreviewEl) {
					const wantR9 = selected.includes('r9');
					if (!wantR9) {
						r9PreviewEl.classList.add('d-none');
						r9PreviewEl.textContent = '';
					} else {
						const examples = [];
						const seenSku = new Set();
						for (const tr of rows) {
							if (examples.length >= 5) break;
							const sku = (tr.getAttribute('data-sku') || '').trim();
							if (!sku || seenSku.has(sku)) continue;
							const rr = (tr.getAttribute('data-auto-rules') || '').split(',').map(s => s.trim()).filter(Boolean);
							if (!rr.includes('r9')) continue;
							const costTd = tr.querySelector('td[data-col="cost"]');
							const costRaw = costTd ? (costTd.getAttribute('data-raw') || '') : '';
							const newPrice = autoPriceFromCost(costRaw, r9cfg);
							if (newPrice === null) continue;
							seenSku.add(sku);
							examples.push(sku + ' ‚Üí ' + Number(newPrice).toLocaleString('th-TH'));
						}

						r9PreviewEl.classList.remove('d-none');
						if (examples.length) {
							r9PreviewEl.textContent = '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠ 9 (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô): ' + examples.join(' | ');
						} else {
							r9PreviewEl.textContent = '‡∏Ç‡πâ‡∏≠ 9: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
						}
					}
				}
			}

			modalEl.addEventListener('change', function (e) {
				if (e.target && e.target.classList && e.target.classList.contains('pm-auto-rule')) {
					refreshAutoPreview();
				}
			});

			if (btnAll) {
				btnAll.addEventListener('click', function () {
					document.querySelectorAll('.pm-auto-rule').forEach(cb => { cb.checked = true; });
					refreshAutoPreview();
				});
			}
			if (btnClear) {
				btnClear.addEventListener('click', function () {
					document.querySelectorAll('.pm-auto-rule').forEach(cb => { cb.checked = false; });
					refreshAutoPreview();
				});
			}

			modalEl.addEventListener('shown.bs.modal', function () {
				refreshAutoPreview();
				Promise.all([
					loadR9CfgOnShow(),
					loadR10CfgOnShow(),
					loadR11CfgOnShow(),
				]).then(() => {
					try { refreshAutoPreview(); } catch (e) { }
				});
			});
			modalEl.addEventListener('hidden.bs.modal', function () {
				// ‡∏•‡πâ‡∏≤‡∏á highlight ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î modal
				document.querySelectorAll('table.pm-table tbody tr.pm-row-auto-selected').forEach(tr => {
					tr.classList.remove('pm-row-auto-selected');
				});
			});
		})();
	</script>

	<script>
		(function () {
			const ownerSel = document.getElementById('ownerSelect');
			const limitSel = document.getElementById('limitSelect');
			const staleDaysSel = document.getElementById('staleDaysSelect');
			const btnEdit = document.getElementById('btnEditFilters');
			const btnSave = document.getElementById('btnSaveFilters');
			const btnCancel = document.getElementById('btnCancelFilters');

			if (!ownerSel || !limitSel || !btnEdit || !btnSave || !btnCancel) return;

			const lockedOwner = ownerSel.value;
			const lockedLimit = limitSel.value;
			const lockedStaleDays = staleDaysSel ? staleDaysSel.value : '';

			function setEdit(on) {
				ownerSel.disabled = !on;
				limitSel.disabled = !on;
				if (staleDaysSel) staleDaysSel.disabled = !on;
				btnEdit.classList.toggle('d-none', on);
				btnSave.classList.toggle('d-none', !on);
				btnCancel.classList.toggle('d-none', !on);
			}

			btnEdit.addEventListener('click', function () {
				setEdit(true);
			});

			btnCancel.addEventListener('click', function () {
				ownerSel.value = lockedOwner;
				limitSel.value = lockedLimit;
				if (staleDaysSel) staleDaysSel.value = lockedStaleDays;
				setEdit(false);
			});
		})();
	</script>

	<script>
		(function () {
			// ‡πÄ‡∏õ‡∏¥‡∏î tooltip ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ title ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
			if (!window.bootstrap || !window.bootstrap.Tooltip) return;
			const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
			tooltipTriggerList.forEach(function (el) {
				el.setAttribute('data-bs-toggle', 'tooltip');
				new bootstrap.Tooltip(el);
			});
		})();
	</script>

	<script>
		(function () {
			const COLS = [
				// ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
				{ key: 'sku', label: 'SKU', group: 'product' },
				{ key: 'brand', label: 'Brand', group: 'product' },
				{ key: 'name', label: 'Name', group: 'product' },
				{ key: 'stock_internal', label: 'Stock Internal', group: 'product' },

				// ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤
				{ key: 'stock', label: 'Stock', group: 'internal' },
				{ key: 'monthly_sales', label: 'Monthly Sales', group: 'internal' },
				{ key: 'cost', label: 'Cost', group: 'internal' },
				{ key: 'our_price', label: 'Our Price', group: 'internal' },

				// ‡∏ï‡∏•‡∏≤‡∏î
				{ key: 'market_best', label: 'Market (best)', group: 'market' },
				{ key: 'voucher', label: 'Voucher', group: 'market' },

				// ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
				{ key: 'brand_control', label: 'Brand Control', group: 'control' },

				// ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á/‡∏Å‡∏≥‡πÑ‡∏£
				{ key: 'gap', label: 'Gap', group: 'profit' },
				{ key: 'profit_our', label: 'Profit@Our', group: 'profit' },
				{ key: 'profit_match', label: 'Profit@Match', group: 'profit' },

				// ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏•‡∏≤‡∏î
				{ key: 'recommend', label: 'Recommend', group: 'market_detail' },
				{ key: 'shop', label: 'Shop', group: 'market_detail' },
				{ key: 'mall', label: 'MALL', group: 'market_detail' },
				{ key: 'url', label: 'URL', group: 'market_detail' },
				{ key: 'owner', label: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', group: 'market_detail' },

				// ‡πÄ‡∏ß‡∏•‡∏≤
				{ key: 'updated', label: 'Updated', group: 'time' },
			];

			const GROUP_LABEL = {
				product: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
				internal: '‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤',
				market: '‡∏ï‡∏•‡∏≤‡∏î',
				control: '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°',
				profit: '‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á/‡∏Å‡∏≥‡πÑ‡∏£',
				market_detail: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏•‡∏≤‡∏î',
				time: '‡πÄ‡∏ß‡∏•‡∏≤',
			};

			const listEl = document.getElementById('pmColsList');
			const btnAll = document.getElementById('pmColsAll');
			const btnReset = document.getElementById('pmColsReset');
			if (!listEl) return;

			const LS_KEY = 'pm_cols_v1_' + "{{ platform }}";

			function loadHiddenSet() {
				try {
					const raw = localStorage.getItem(LS_KEY);
					if (!raw) return new Set();
					const arr = JSON.parse(raw);
					return new Set(Array.isArray(arr) ? arr : []);
				} catch (e) {
					return new Set();
				}
			}

			function saveHiddenSet(hidden) {
				localStorage.setItem(LS_KEY, JSON.stringify(Array.from(hidden)));
			}

			let hidden = loadHiddenSet();

			function visibleCount() {
				return COLS.filter(c => !hidden.has(c.key)).length;
			}

			function renderPicker() {
				listEl.innerHTML = '';

				const groups = ['product', 'internal', 'market', 'control', 'profit', 'market_detail', 'time'];
				groups.forEach(g => {
					const title = document.createElement('div');
					title.className = 'pm-cols-group-title';
					title.textContent = GROUP_LABEL[g] || g;
					listEl.appendChild(title);

					COLS.filter(c => c.group === g).forEach(c => {
						const row = document.createElement('div');
						row.className = 'pm-cols-item';
						const id = 'pmcol_' + c.key;
						row.innerHTML =
							'<input class="form-check-input m-0" style="margin:0" type="checkbox" id="' + id + '" data-key="' + c.key + '">' +
							'<label class="mb-0" style="cursor:pointer" for="' + id + '">' + c.label + '</label>';
						listEl.appendChild(row);
					});
				});

				listEl.querySelectorAll('input[data-key]').forEach(cb => {
					const k = cb.getAttribute('data-key');
					cb.checked = !hidden.has(k);
				});
			}

			function toggleCol(key, show) {
				document.querySelectorAll('[data-col="' + key + '"]').forEach(el => {
					el.classList.toggle('pm-col-hidden', !show);
				});
			}

			function updateGroupColspans() {
				const groupThs = document.querySelectorAll('thead .pm-group-row th[data-group]');
				groupThs.forEach(th => {
					const g = th.getAttribute('data-group');
					const keys = COLS.filter(c => c.group === g).map(c => c.key);
					const count = keys.filter(k => !hidden.has(k)).length;

					if (count <= 0) {
						th.style.display = 'none';
						th.colSpan = 1;
					} else {
						th.style.display = '';
						th.colSpan = count;
					}
				});
			}

			function updateEmptyRowColspan() {
				const vc = visibleCount();
				document.querySelectorAll('tbody td[colspan]').forEach(td => {
					td.colSpan = vc;
				});
			}

			function updateStickyTop() {
				const groupRow = document.querySelector('thead .pm-group-row');
				const h = groupRow ? groupRow.offsetHeight : 0;
				document.documentElement.style.setProperty('--pm-group-h', h + 'px');
			}

			function applyAll() {
				if (visibleCount() === 0) {
					hidden.delete('sku');
				}

				COLS.forEach(c => {
					toggleCol(c.key, !hidden.has(c.key));
				});

				updateGroupColspans();
				updateEmptyRowColspan();
				updateStickyTop();
				saveHiddenSet(hidden);
			}

			listEl.addEventListener('change', (e) => {
				const cb = e.target;
				if (!cb || !cb.matches('input[data-key]')) return;

				const key = cb.getAttribute('data-key');
				if (cb.checked) hidden.delete(key);
				else hidden.add(key);

				applyAll();
			});

			if (btnAll) {
				btnAll.addEventListener('click', () => {
					hidden = new Set();
					renderPicker();
					applyAll();
				});
			}

			if (btnReset) {
				btnReset.addEventListener('click', () => {
					hidden = new Set();
					renderPicker();
					applyAll();
				});
			}

			renderPicker();
			applyAll();
			window.addEventListener('resize', () => updateStickyTop());

			// expose for infinite scroll: apply to newly appended rows
			window.pmApplyColumns = applyAll;
		})();
	</script>

	<script>
		(function () {
			const btn = document.getElementById('btnEditProducts');
			const table = document.querySelector('table.pm-table');
			if (!btn || !table) return;

			const PLATFORM = "{{ platform }}";
			const FEE_PCT = Number("{{ fee.fee_pct or 0 }}");
			const FIXED_FEE = Number("{{ fee.fixed_fee or 0 }}");
			const EDIT_COLS = new Set(['market_best', 'voucher', 'shop', 'url']);
			const PROMPT_NUM_COLS = new Set(['cost', 'our_price', 'brand_control']);
			let editOn = false;

			// state ‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß: sku -> { original, pending, tr }
			const states = new Map();

			function getState(tr) {
				const sku = (tr.getAttribute('data-sku') || '').trim();
				if (!sku) return null;
				if (!states.has(sku)) {
					states.set(sku, { sku, tr, original: {}, pending: {} });
				}
				return states.get(sku);
			}

			function getTd(tr, col) {
				return tr.querySelector('td[data-col="' + col + '"]');
			}

			function addSaveBadge(tr) {
				const td = getTd(tr, 'updated');
				if (!td) return;
				if (!td.querySelector('.pm-save-badge')) {
					td.insertAdjacentHTML('beforeend', ' <span class="pm-save-badge">‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>');
				}
				tr.classList.add('pm-row-dirty');
			}

			function clearSaveBadge(tr) {
				const td = getTd(tr, 'updated');
				if (!td) return;
				const b = td.querySelector('.pm-save-badge');
				if (b) b.remove();
				tr.classList.remove('pm-row-dirty');
			}

			function renderCell(td, col, raw) {
				const v = (raw ?? '').toString().trim();

				if (col === 'url') {
					if (v) {
						td.innerHTML = '<a class="btn btn-sm btn-outline-primary" href="' + v.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a>';
					} else {
						td.innerHTML = '<span class="text-muted">-</span>';
					}
					td.setAttribute('data-raw', v);
					return;
				}

				if (col === 'shop') {
					td.textContent = v;
					td.setAttribute('title', v);
					td.setAttribute('data-raw', v);
					return;
				}

				if (col === 'market_best' || col === 'voucher' || col === 'cost' || col === 'our_price' || col === 'brand_control') {
					if (!v) {
						td.textContent = '';
						td.setAttribute('data-raw', '');
						return;
					}
					const num = Number(v.replace(/,/g, ''));
					td.textContent = Number.isFinite(num)
						? num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
						: v;
					td.setAttribute('data-raw', v);
					return;
				}
			}

			function _num(s) {
				const t = (s ?? '').toString().trim().replace(/,/g, '');
				if (!t) return null;
				const n = Number(t);
				return Number.isFinite(n) ? n : null;
			}
			function _intFromTd(tr, col) {
				const td = tr.querySelector('td[data-col="' + col + '"]');
				if (!td) return null;
				const t = (td.textContent || '').toString().trim().replace(/,/g, '');
				if (!t) return null;
				const n = parseInt(t, 10);
				return Number.isFinite(n) ? n : null;
			}
			function _fmt2(n) {
				return (n === null || n === undefined || !Number.isFinite(n)) ? ''
					: n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
			}
			function _fmtPct(n) {
				if (n === null || n === undefined || !Number.isFinite(n)) return '';
				return (n >= 0) ? ('+' + n.toFixed(1)) : n.toFixed(1);
			}
			function _profit(price, cost) {
				// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: pack_cost/ship_subsidy ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ -> ‡πÉ‡∏ä‡πâ 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠ preview
				const feeAmt = (price * (FEE_PCT / 100)) + FIXED_FEE;
				return price - cost - feeAmt;
			}

			const REC = {
				no_market: { text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î', cls: 'badge pm-badge pm-badge-neutral' },
				missing_internal: { text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', cls: 'badge pm-badge pm-badge-neutral' },
				equal_price: { text: '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô', cls: 'badge pm-badge pm-badge-neutral' },
				market_cheaper: { text: '‡∏ï‡∏•‡∏≤‡∏î‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤', cls: 'badge pm-badge pm-badge-info' },
				follow_ok: { text: '‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ', cls: 'badge pm-badge pm-badge-ok' },
				loss_0_5: { text: '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô(0-5%)', cls: 'badge pm-badge pm-badge-orange-subtle' },
				loss_6_10: { text: '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô(6-10%)', cls: 'badge pm-badge pm-badge-orange' },
				loss_heavy: { text: '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏´‡∏ô‡∏±‡∏Å', cls: 'badge pm-badge pm-badge-red-dark' },
			};

			function recalcRow(tr, st) {
				if (!tr) return;

				function getRaw(col) {
					if (st && st.pending && (col in st.pending)) return st.pending[col];
					const td = tr.querySelector('td[data-col="' + col + '"]');
					return td ? (td.getAttribute('data-raw') || '') : '';
				}

				const cost = _num(getRaw('cost'));
				const our = _num(getRaw('our_price'));
				const mk = _num(getRaw('market_best'));

				// --- Gap ---
				const tdGap = tr.querySelector('td[data-col="gap"]');
				if (tdGap) {
					if (our !== null && mk !== null && mk > 0) {
						const gap = our - mk;
						const pct = (gap / mk) * 100;
						const cls = (pct > 0) ? 'text-danger' : (pct < 0 ? 'text-success' : 'text-muted');
						tdGap.innerHTML = '<div class="fw-semibold">' + _fmt2(gap) + '</div>'
							+ '<div class="small ' + cls + '">(' + _fmtPct(pct) + '%)</div>';
					} else {
						tdGap.innerHTML = '';
					}
				}

				// --- Profit@Our ---
				const tdPO = tr.querySelector('td[data-col="profit_our"]');
				if (tdPO) {
					if (our !== null && our > 0 && cost !== null) {
						const p = _profit(our, cost);
						const pct = (p / our) * 100;
						const cls = (pct < 0) ? 'text-danger' : (pct > 0 ? 'text-success' : 'text-muted');
						tdPO.innerHTML = '<div class="fw-semibold">' + _fmt2(p) + '</div>'
							+ '<div class="small ' + cls + '">(' + _fmtPct(pct) + '%)</div>';
					} else {
						tdPO.innerHTML = '';
					}
				}

				// --- Profit@Match ---
				const tdPM = tr.querySelector('td[data-col="profit_match"]');
				let profitMatchPct = null;
				if (tdPM) {
					if (mk !== null && mk > 0 && cost !== null) {
						const p = _profit(mk, cost);
						profitMatchPct = (p / mk) * 100;
						const cls = (profitMatchPct < 0) ? 'text-danger' : (profitMatchPct > 0 ? 'text-success' : 'text-muted');
						tdPM.innerHTML = '<div class="fw-semibold">' + _fmt2(p) + '</div>'
							+ '<div class="small ' + cls + '">(' + _fmtPct(profitMatchPct) + '%)</div>';
					} else {
						tdPM.innerHTML = '';
					}
				}

				// --- Recommend ---
				const tdRec = tr.querySelector('td[data-col="recommend"]');
				if (tdRec) {
					const recKeys = [];

					const noMarket = (mk === null || mk <= 0);
					const missingInternal = (cost === null || our === null || our <= 0);

					if (noMarket) recKeys.push('no_market');
					if (missingInternal) recKeys.push('missing_internal');

					if (!missingInternal && !noMarket) {
						if (Math.abs(our - mk) < 0.01) recKeys.push('equal_price');
						else if (mk < our) recKeys.push('market_cheaper');
					}

					if (!noMarket && cost !== null && profitMatchPct !== null) {
						if (profitMatchPct >= 0) recKeys.push('follow_ok');
						else if (profitMatchPct > -6) recKeys.push('loss_0_5');
						else if (profitMatchPct > -10) recKeys.push('loss_6_10');
						else recKeys.push('loss_heavy');
					}

					const stockInternal = _intFromTd(tr, 'stock_internal');
					const monthlySales = _intFromTd(tr, 'monthly_sales');
					const ageTags = [];

					const noSales = (monthlySales === 0) && (stockInternal !== null && stockInternal >= 1);
					if (noSales) {
						ageTags.push({ text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', cls: 'badge bg-secondary-subtle text-secondary' });
					}

					if (stockInternal !== null && monthlySales !== null) {
						if ((monthlySales * 12 - stockInternal) < 0) ageTags.push({ text: 'Aging(1‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)', cls: 'badge bg-danger-subtle text-danger' });
						else if ((monthlySales * 6 - stockInternal) < 0) ageTags.push({ text: 'Aging(6‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)', cls: 'badge bg-warning text-dark' });
						else if ((monthlySales * 3 - stockInternal) < 0) ageTags.push({ text: 'Aging(3‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)', cls: 'badge bg-warning-subtle text-warning-emphasis' });
					}

					const parts = [];
					for (const k of recKeys) {
						const def = REC[k];
						if (def) parts.push('<span class="' + def.cls + '">' + def.text + '</span>');
					}
					for (const t of ageTags) {
						parts.push('<span class="' + t.cls + '">' + t.text + '</span>');
					}
					if (parts.length === 0) parts.push('<span class="text-muted">-</span>');
					tdRec.innerHTML = '<div class="d-flex flex-wrap gap-1">' + parts.join('') + '</div>';
				}
			}

			async function postUpdate(payload) {
				const res = await fetch('/api/price/dashboard/update_cell', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload),
				});
				const json = await res.json().catch(() => ({}));
				if (!res.ok || json.success === false) {
					throw new Error(json.msg || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
				}
				return json;
			}

			function setEdit(on) {
				editOn = !!on;
				document.body.classList.toggle('pm-edit-products-on', editOn);
				btn.classList.toggle('pm-edit-on', editOn);
				btn.classList.toggle('btn-outline-warning', !editOn);
				btn.classList.toggle('btn-warning', editOn);
				btn.innerHTML = editOn
					? '<i class="bi bi-pencil-square me-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î)'
					: '<i class="bi bi-pencil-square me-1"></i>Edit ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
			}
			btn.addEventListener('click', () => setEdit(!editOn));
			setEdit(false);

			function openInline(td) {
				const col = (td.getAttribute('data-col') || '').trim();
				const tr = td.closest('tr[data-sku]');
				if (!tr) return;

				const st = getState(tr);
				if (!st) return;

				const raw = (td.getAttribute('data-raw') || '').toString();
				if (!(col in st.original)) {
					st.original[col] = raw;
				}

				const input = document.createElement('input');
				input.className = 'form-control form-control-sm pm-inline-input';
				input.type = 'text';
				input.value = raw;

				if (col === 'market_best' || col === 'voucher') {
					input.inputMode = 'decimal';
					input.placeholder = '‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...';
				} else if (col === 'url') {
					input.placeholder = '‡∏ß‡∏≤‡∏á URL...';
				} else {
					input.placeholder = '‡∏ß‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô...';
				}

				td.innerHTML = '';
				td.appendChild(input);
				input.focus();
				input.select();

				function commit() {
					const newRaw = (input.value || '').trim();

					if ((col === 'market_best' || col === 'voucher') && newRaw) {
						const num = Number(newRaw.replace(/,/g, ''));
						if (!Number.isFinite(num)) {
							alert('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
							renderCell(td, col, st.pending[col] ?? raw);
							return;
						}
					}

					st.pending[col] = newRaw;
					renderCell(td, col, newRaw);
					addSaveBadge(tr);
					recalcRow(tr, st);
				}

				// preview ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏ß‡∏≤‡∏á
				input.addEventListener('input', () => {
					st.pending[col] = (input.value || '').trim();
					addSaveBadge(tr);
					recalcRow(tr, st);
				});

				input.addEventListener('keydown', (e) => {
					if (e.key === 'Enter') { e.preventDefault(); commit(); }
					if (e.key === 'Escape') {
						e.preventDefault();
						const back = st.pending[col] ?? raw;
						renderCell(td, col, back);
					}
				});
				input.addEventListener('blur', commit);
			}

			async function promptNumberAndSave(td, tr, col) {
				const sku = (tr.getAttribute('data-sku') || '').trim();
				const marketId = (tr.getAttribute('data-market-id') || '').trim() || null;
				if (!sku) return;

				const cur = (td.getAttribute('data-raw') || '').toString();
				const input = window.prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ' + col + ' (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ñ‡πà‡∏≤)', cur);
				if (input === null) return;

				const s = input.trim();
				let val = null;
				if (s !== '') {
					const num = Number(s.replace(/,/g, ''));
					if (!Number.isFinite(num)) {
						alert('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
						return;
					}
					val = num;
				}

				td.classList.add('pm-cell-editing');
				try {
					const out = await postUpdate({
						sku,
						col,
						value: val,
						platform: PLATFORM,
						market_item_id: marketId ? Number(marketId) : null,
					});
					td.setAttribute('data-raw', (s === '' ? '' : String(val)));
					td.textContent = out.display || '';
					recalcRow(tr, getState(tr));
				} catch (e) {
					alert(e.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
				} finally {
					td.classList.remove('pm-cell-editing');
				}
			}

			async function toggleMall(td, tr) {
				const sku = (tr.getAttribute('data-sku') || '').trim();
				const marketId = (tr.getAttribute('data-market-id') || '').trim() || null;
				if (!sku) return;

				const curRaw = (td.getAttribute('data-raw') || '0').toString().trim();
				const nextVal = !(curRaw === '1' || curRaw === 'true');

				td.classList.add('pm-cell-editing');
				try {
					const out = await postUpdate({
						sku,
						col: 'mall',
						value: nextVal,
						platform: PLATFORM,
						market_item_id: marketId ? Number(marketId) : null,
					});

					td.setAttribute('data-raw', nextVal ? '1' : '0');
					td.innerHTML = nextVal
						? '<span class="badge bg-success-subtle text-success">MALL</span>'
						: '<span class="text-muted">-</span>';

					if (out.market_item_id) {
						tr.setAttribute('data-market-id', String(out.market_item_id));
					}
				} catch (e) {
					alert(e.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
				} finally {
					td.classList.remove('pm-cell-editing');
				}
			}

			// ---- Updated modal (Bootstrap ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ fallback) ----
			const modalEl = document.getElementById('pmUpdatedModal');
			const inputEl = document.getElementById('pmUpdatedInput');
			const btnNow = document.getElementById('pmUpdatedNowBtn');
			const btnOk = document.getElementById('pmUpdatedOkBtn');
			const btnCancel = document.getElementById('pmUpdatedCancelBtn');

			let bsModal = null;
			if (window.bootstrap && window.bootstrap.Modal && modalEl) {
				bsModal = new bootstrap.Modal(modalEl);
			}

			let backdrop = null;
			function showModal() {
				if (bsModal) { bsModal.show(); return; }
				if (!modalEl) return;
				modalEl.classList.add('show');
				modalEl.style.display = 'block';
				modalEl.removeAttribute('aria-hidden');
				document.body.classList.add('modal-open');
				backdrop = document.createElement('div');
				backdrop.className = 'modal-backdrop fade show';
				document.body.appendChild(backdrop);
			}
			function hideModal() {
				if (bsModal) { bsModal.hide(); return; }
				if (!modalEl) return;
				modalEl.classList.remove('show');
				modalEl.style.display = 'none';
				modalEl.setAttribute('aria-hidden', 'true');
				document.body.classList.remove('modal-open');
				if (backdrop) { backdrop.remove(); backdrop = null; }
			}

			// ‡∏õ‡∏∏‡πà‡∏° X ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ bootstrap
			if (modalEl) {
				modalEl.querySelectorAll('[data-bs-dismiss="modal"]').forEach((x) => {
					x.addEventListener('click', hideModal);
				});
			}

			let ctx = null; // { tr, st }

			async function saveRow(updatedValue) {
				if (!ctx || !ctx.tr || !ctx.st) return;
				const tr = ctx.tr;
				const st = ctx.st;
				const sku = st.sku;
				let marketId = (tr.getAttribute('data-market-id') || '').trim() || null;

				for (const col of ['shop', 'market_best', 'voucher', 'url']) {
					if (!(col in st.pending)) continue;
					const raw = (st.pending[col] || '').trim();
					if (col === 'shop' && !raw) {
						throw new Error('Shop ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á');
					}

					let val = raw;
					if (col === 'market_best' || col === 'voucher') {
						val = raw ? Number(raw.replace(/,/g, '')) : null;
						if (raw && !Number.isFinite(val)) {
							throw new Error('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
						}
					}

					const out = await postUpdate({
						sku,
						col,
						value: val,
						platform: PLATFORM,
						market_item_id: marketId ? Number(marketId) : null,
					});

					if (out.market_item_id) {
						marketId = String(out.market_item_id);
						tr.setAttribute('data-market-id', marketId);
					}

					const td = getTd(tr, col);
					if (td) {
						td.setAttribute('data-raw', raw);
						renderCell(td, col, raw);
					}
				}

				const outU = await postUpdate({
					sku,
					col: 'updated',
					value: updatedValue,
					platform: PLATFORM,
					market_item_id: marketId ? Number(marketId) : null,
				});

				if (outU.market_item_id) {
					tr.setAttribute('data-market-id', String(outU.market_item_id));
				}

				const tdU = getTd(tr, 'updated');
				if (tdU) {
					tdU.setAttribute('data-raw', outU.iso || '');
					tdU.textContent = outU.display || '-';
				}

				clearSaveBadge(tr);
				states.delete(sku);
				recalcRow(tr, null);
			}

			function cancelRow() {
				if (!ctx || !ctx.tr || !ctx.st) return;
				const tr = ctx.tr;
				const st = ctx.st;
				for (const col of ['market_best', 'voucher', 'shop', 'url']) {
					if (!(col in st.original)) continue;
					const td = getTd(tr, col);
					if (!td) continue;
					renderCell(td, col, st.original[col]);
					td.setAttribute('data-raw', st.original[col] || '');
				}
				clearSaveBadge(tr);
				states.delete(st.sku);
				recalcRow(tr, null);
			}

			function openUpdated(tr) {
				const st = getState(tr);
				if (!st) return;
				ctx = { tr, st };
				if (inputEl) {
					inputEl.value = '';
					inputEl.focus();
				}
				showModal();
			}

			if (btnNow) {
				btnNow.addEventListener('click', async () => {
					try {
						btnNow.disabled = true;
						await saveRow('NOW');
						hideModal();
					} catch (e) {
						alert(e.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
					} finally {
						btnNow.disabled = false;
					}
				});
			}

			if (btnOk) {
				btnOk.addEventListener('click', async () => {
					try {
						btnOk.disabled = true;
						const v = (inputEl ? inputEl.value.trim() : '');
						await saveRow(v || 'NOW');
						hideModal();
					} catch (e) {
						alert(e.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
					} finally {
						btnOk.disabled = false;
					}
				});
			}

			if (btnCancel) {
				btnCancel.addEventListener('click', () => {
					cancelRow();
					hideModal();
				});
			}

			// Click handler
			table.addEventListener('click', (e) => {
				const td = e.target.closest('td.pm-editable');
				if (!td) return;
				const col = (td.getAttribute('data-col') || '').trim();
				const tr = td.closest('tr[data-sku]');
				if (!tr || !col) return;

				// FIX: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î Edit ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå/‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå URL
				// ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ó‡∏ô
				if (col === 'url' && editOn) {
					const a = e.target.closest('a');
					// ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Ctrl+Click / Cmd+Click ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ
					if (a && !(e.ctrlKey || e.metaKey)) {
						e.preventDefault();
						e.stopPropagation();
					}
					openInline(td);
					return;
				}

				// Updated ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å badge ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á)
				if (col === 'updated') {
					openUpdated(tr);
					return;
				}

				if (!editOn) return;

				if (EDIT_COLS.has(col)) {
					openInline(td);
					return;
				}
				if (col === 'mall') {
					toggleMall(td, tr);
					return;
				}
				if (PROMPT_NUM_COLS.has(col)) {
					promptNumberAndSave(td, tr, col);
					return;
				}
			});
		})();
	</script>

	<script>
		(function () {
			function getUrl() { return new URL(window.location.href); }

			function parseKpis(url) {
				const raw = (url.searchParams.get('kpi') || '').trim();
				if (!raw) return [];
				return raw.split(',').map(s => s.trim()).filter(Boolean).filter(k => k !== 'tracked');
			}

			function writeKpis(url, arr) {
				const seen = new Set();
				const out = [];
				(arr || []).forEach(k => {
					if (k && !seen.has(k)) {
						seen.add(k);
						out.push(k);
					}
				});
				if (out.length) url.searchParams.set('kpi', out.join(','));
				else url.searchParams.delete('kpi');
			}

			function nav(url) { window.location.href = url.toString(); }

			// ‚úÖ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Master (‡πÑ‡∏°‡πà‡∏¢‡∏±‡∏î master ‡πÄ‡∏Ç‡πâ‡∏≤ kpi)
			document.querySelectorAll('.pm-kpi-master-dot').forEach(btn => {
				btn.addEventListener('click', (e) => {
					e.stopPropagation();
					const key = (btn.getAttribute('data-master') || '').trim();
					if (!key) return;

					const url = getUrl();
					let kpis = parseKpis(url);
					const curMaster = (url.searchParams.get('master') || '').trim();

					if (curMaster === key) url.searchParams.delete('master');
					else url.searchParams.set('master', key);

					// ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥: master ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô kpi
					kpis = kpis.filter(x => x !== key);
					writeKpis(url, kpis);
					nav(url);
				});
			});

			// ‚úÖ checkbox ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
			document.querySelectorAll('.pm-kpi-filter').forEach(cb => {
				cb.addEventListener('click', (e) => e.stopPropagation());

				cb.addEventListener('change', () => {
					const key = (cb.getAttribute('data-kpi') || '').trim();
					if (!key) return;

					const url = getUrl();
					let kpis = parseKpis(url);
					const curMaster = (url.searchParams.get('master') || '').trim();

					// ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å/‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô master -> ‡∏Ñ‡∏∏‡∏° master ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
					if (key === curMaster) {
						if (!cb.checked) url.searchParams.delete('master');
						kpis = kpis.filter(x => x !== key);
						writeKpis(url, kpis);
						nav(url);
						return;
					}

					// ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ master ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡πä‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å -> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô master (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà kpi)
					if (!curMaster && cb.checked) {
						url.searchParams.set('master', key);
						kpis = kpis.filter(x => x !== key);
						writeKpis(url, kpis);
						nav(url);
						return;
					}

					// ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô kpi
					if (cb.checked) {
						if (!kpis.includes(key)) kpis.push(key);
					} else {
						kpis = kpis.filter(x => x !== key);
					}

					writeKpis(url, kpis);
					nav(url);
				});
			});

			// ‚úÖ Click card toggles checkbox (tracked = clear all)
			document.querySelectorAll('.pm-kpi[data-kpi]').forEach(card => {
				card.addEventListener('click', () => {
					const key = (card.getAttribute('data-kpi') || '').trim();
					const url = getUrl();

					if (key === 'tracked') {
						url.searchParams.delete('kpi');
						url.searchParams.delete('master');
						nav(url);
						return;
					}

					const cb = card.querySelector('.pm-kpi-filter');
					if (cb) {
						cb.checked = !cb.checked;
						cb.dispatchEvent(new Event('change', { bubbles: true }));
					}
				});
			});
		})();
	</script>

	<script>
		(function () {
			const tbody = document.getElementById('pmTbody');
			const sentinel = document.getElementById('pmInfiniteSentinel');
			const spinner = document.getElementById('pmInfiniteSpinner');
			const text = document.getElementById('pmInfiniteText');
			if (!tbody || !sentinel) return;

			const key = (tbody.dataset.key || '').trim();
			const total = parseInt(tbody.dataset.total || '0', 10);
			const pageSize = parseInt(tbody.dataset.pagesize || '200', 10);
			let loaded = parseInt(tbody.dataset.loaded || '0', 10);

			if (!key || total <= loaded) {
				sentinel.style.display = 'none';
				return;
			}

			function getScrollParent(el) {
				while (el && el !== document.body) {
					const st = getComputedStyle(el);
					if (/(auto|scroll)/.test(st.overflowY)) return el;
					el = el.parentElement;
				}
				return null;
			}
			const scrollRoot = getScrollParent(tbody);

			let loading = false;
			let observer = null;

			async function loadMore() {
				if (loading) return;
				if (loaded >= total) {
					if (text) text.textContent = '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
					if (spinner) spinner.classList.add('d-none');
					return;
				}
				loading = true;
				if (spinner) spinner.classList.remove('d-none');
				if (text) text.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

				try {
					const url = `/api/price/dashboard/rows?key=${encodeURIComponent(key)}&offset=${loaded}&limit=${pageSize}`;
					const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
					const out = await res.json();

					if (!out || out.success !== true) {
						if (text) text.textContent = (out && out.msg) ? out.msg : '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
						return;
					}

					if (out.html) {
						tbody.insertAdjacentHTML('beforeend', out.html);

						// apply column visibility + colspans to newly appended rows
						if (window.pmApplyColumns) {
							window.pmApplyColumns();
						}
					}

					loaded = out.next_offset || (loaded + pageSize);
					tbody.dataset.loaded = String(loaded);

					if (!out.has_more || loaded >= total) {
						if (text) text.textContent = '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
						sentinel.style.opacity = '0.6';
						if (observer) observer.disconnect();
					} else {
						if (text) text.textContent = '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°';
					}
				} catch (e) {
					if (text) text.textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ Network/Console)';
				} finally {
					if (spinner) spinner.classList.add('d-none');
					loading = false;
				}
			}

			if ('IntersectionObserver' in window) {
				observer = new IntersectionObserver((entries) => {
					if (entries.some(e => e.isIntersecting)) loadMore();
				}, { root: scrollRoot, rootMargin: '600px 0px', threshold: 0 });
				observer.observe(sentinel);
			} else {
				const rootEl = scrollRoot || window;
				const handler = () => {
					const rect = sentinel.getBoundingClientRect();
					if (rect.top < window.innerHeight + 600) loadMore();
				};
				rootEl.addEventListener('scroll', handler, { passive: true });
			}
		})();
	</script>

	<!-- jQuery UI Autocomplete for Brand inputs (Rule 4/5) -->
	<!-- NOTE: jQuery is loaded in base.html at the bottom of the page.
	 So we dynamically load jQuery UI AFTER jQuery is available to avoid race/order issues. -->

	<style>
		/* Autocomplete dropdown (use Bootstrap tokens; keep above modal) */
		.ui-front {
			z-index: 99999 !important;
		}

		.ui-autocomplete {
			max-height: 250px;
			overflow-y: auto;
			overflow-x: hidden;
			border-radius: 12px;
			padding: 6px;
			box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, .10);
			border: 1px solid rgba(var(--bs-body-color-rgb), .08);
			background: var(--bs-body-bg);
			font-family: var(--bs-body-font-family);
		}

		.ui-menu-item .ui-menu-item-wrapper {
			padding: 8px 12px;
			border-radius: 8px;
			font-size: 0.9rem;
			color: var(--bs-body-color);
		}

		.ui-menu-item .ui-menu-item-wrapper.ui-state-active {
			background: var(--bs-primary);
			color: #fff;
			border: none;
			font-weight: 600;
		}
	</style>

	<script type="application/json" id="pmBrandsJson">{{ brands|default([])|tojson }}</script>

	<script>
		(function () {
			function getBrands() {
				const el = document.getElementById('pmBrandsJson');
				if (!el) return [];
				try { return JSON.parse(el.textContent || '[]') || []; } catch (e) { return []; }
			}
			const availableBrands = getBrands();

			let uiLoading = null;
			function ensureJqueryUiLoaded() {
				// Wait until jQuery exists, then load jQuery UI exactly once.
				if (uiLoading) return uiLoading;
				uiLoading = new Promise((resolve, reject) => {
					if (!window.jQuery) return reject(new Error('jQuery not ready'));
					const $ = window.jQuery;
					if ($.ui && $.ui.autocomplete) return resolve(true);

					// CSS
					const cssHref = 'https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css';
					if (!document.querySelector(`link[data-jqui="1"]`)) {
						const link = document.createElement('link');
						link.rel = 'stylesheet';
						link.href = cssHref;
						link.setAttribute('data-jqui', '1');
						document.head.appendChild(link);
					}

					// JS
					if (document.querySelector('script[data-jqui="1"]')) {
						// Script tag exists; wait a bit and resolve if ready
						const t = setInterval(() => {
							const $2 = window.jQuery;
							if ($2 && $2.ui && $2.ui.autocomplete) {
								clearInterval(t);
								resolve(true);
							}
						}, 100);
						setTimeout(() => { clearInterval(t); reject(new Error('jQuery UI load timeout')); }, 5000);
						return;
					}

					const script = document.createElement('script');
					script.src = 'https://code.jquery.com/ui/1.13.2/jquery-ui.js';
					script.async = true;
					script.setAttribute('data-jqui', '1');
					script.onload = () => resolve(true);
					script.onerror = () => reject(new Error('Failed to load jQuery UI'));
					document.head.appendChild(script);
				});
				return uiLoading;
			}

			let inited = false;
			function initBrandAutocomplete() {
				if (inited) return true;
				if (!window.jQuery) return false;
				const $ = window.jQuery;
				if (!$.ui || !$.ui.autocomplete) return false;

				function split(val) {
					return String(val || '').split(/,\s*/);
				}
				function extractLast(term) {
					return split(term).pop();
				}

				const $inputs = $("input[name='stock_brands_4'], input[name='stock_brands_5']");
				if (!$inputs.length) return false;

				$inputs
					.on('keydown', function (event) {
						const inst = $(this).autocomplete('instance');
						if (!inst) return;
						if (event.keyCode === $.ui.keyCode.TAB && inst.menu && inst.menu.active) {
							event.preventDefault();
						}
					})
					.autocomplete({
						minLength: 0,
						source: function (request, response) {
							response($.ui.autocomplete.filter(availableBrands, extractLast(request.term)));
						},
						focus: function () {
							return false;
						},
						select: function (event, ui) {
							const terms = split(this.value);
							terms.pop();
							terms.push(ui.item.value);
							terms.push('');
							this.value = terms.join(', ');
							return false;
						}
					});
				inited = true;
				return true;
			}

			function tryInitWithRetry(retriesLeft) {
				if (retriesLeft <= 0) return;
				if (!window.jQuery) {
					setTimeout(() => tryInitWithRetry(retriesLeft - 1), 150);
					return;
				}
				ensureJqueryUiLoaded()
					.then(() => {
						if (!initBrandAutocomplete()) {
							setTimeout(() => tryInitWithRetry(retriesLeft - 1), 150);
						}
					})
					.catch(() => {
						setTimeout(() => tryInitWithRetry(retriesLeft - 1), 250);
					});
			}

			// Run after all scripts (including deferred jquery-ui) are ready
			window.addEventListener('load', () => tryInitWithRetry(20));

			// Also retry whenever the modal is opened
			document.addEventListener('DOMContentLoaded', () => {
				const modalEl = document.getElementById('exportStockAdjModal');
				if (modalEl) {
					modalEl.addEventListener('shown.bs.modal', () => tryInitWithRetry(10));
				}
			});
		})();
	</script>

</div>

<div class="pm-zoom-ctrl d-print-none" id="pmZoomCtrl">
	<button id="pmZoomClose" type="button" class="btn btn-sm btn-light border" title="‡∏ã‡πà‡∏≠‡∏ô Zoom">
		<i class="bi bi-x"></i>
	</button>
	<span class="small text-muted">Zoom</span>
	<input id="pmZoom" class="form-range" type="range" min="70" max="115" value="100">
	<span id="pmZoomVal" class="small fw-bold">100%</span>
	<button id="pmZoomReset" type="button" class="btn btn-sm btn-light border">Reset</button>
</div>

<button class="pm-zoom-fab d-print-none pm-zoom-hidden" id="pmZoomFab" type="button" title="‡πÄ‡∏õ‡∏¥‡∏î Zoom">
	<i class="bi bi-zoom-in"></i>
</button>

<script>
	(function () {
		const wrap = document.getElementById('pmPageWrap');
		const r = document.getElementById('pmZoom');
		const v = document.getElementById('pmZoomVal');
		const reset = document.getElementById('pmZoomReset');
		if (!wrap || !r || !v || !reset) return;

		const KEY = 'pm_zoom_v1';
		const supportsZoom = (function () {
			try {
				return (window.CSS && CSS.supports && CSS.supports('zoom', '1')) || ('zoom' in wrap.style);
			} catch (e) { return false; }
		})();

		function clampZoom(pct) {
			const n = Number(pct);
			if (!Number.isFinite(n)) return 100;
			return Math.max(70, Math.min(115, n));
		}

		function apply(pct) {
			const z = clampZoom(pct);
			v.textContent = z + '%';
			r.value = String(z);
			localStorage.setItem(KEY, String(z));

			if (!supportsZoom) return; // fallback: ‡πÅ‡∏Ñ‡πà‡∏à‡∏≥‡∏Ñ‡πà‡∏≤/‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ layout ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
			wrap.style.zoom = String(z / 100);
		}

		r.addEventListener('input', () => apply(r.value));
		reset.addEventListener('click', () => apply(100));
		apply(localStorage.getItem(KEY) || 100);
	})();
</script>

<script>
	(function () {
		const ctrl = document.getElementById('pmZoomCtrl');
		const fab = document.getElementById('pmZoomFab');
		const close = document.getElementById('pmZoomClose');
		if (!ctrl || !fab) return;

		const KEY_UI = 'pm_zoom_ui_hidden_v1';
		function setVisible(on) {
			ctrl.classList.toggle('pm-zoom-hidden', !on);
			fab.classList.toggle('pm-zoom-hidden', on);
			localStorage.setItem(KEY_UI, on ? '0' : '1');
		}

		const hidden = (localStorage.getItem(KEY_UI) === '1');
		setVisible(!hidden);

		close?.addEventListener('click', () => setVisible(false));
		fab?.addEventListener('click', () => setVisible(true));

		document.addEventListener('keydown', (e) => {
			const key = (e.key || '').toLowerCase();
			if ((e.ctrlKey || e.metaKey) && e.altKey && key === 'z') {
				e.preventDefault();
				const nowHidden = ctrl.classList.contains('pm-zoom-hidden');
				setVisible(nowHidden);
			}
		});
	})();
</script>

{% endblock %}